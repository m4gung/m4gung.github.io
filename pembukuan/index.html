<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Pembukuan Usaha Pompanisasi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      background-color: #f5f5f5;
    }
    .app-container {
      min-height: 100vh;
    }
    .sidebar {
      min-width: 230px;
      max-width: 230px;
      background-color: #ffffff;
      border-right: 1px solid #dee2e6;
    }
    .sidebar .nav-link {
      border-radius: 0.375rem;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    .sidebar .nav-link.active {
      background-color: #0d6efd;
      color: #fff;
    }
    .content-area {
      padding: 1rem 1.5rem;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .table-sm td, .table-sm th {
      padding: 0.3rem 0.4rem;
    }
    .text-small {
      font-size: 0.85rem;
    }

    /* Dark mode */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode .sidebar {
      background-color: #1e1e1e;
      border-color: #333;
    }
    body.dark-mode .sidebar .nav-link {
      color: #e0e0e0;
    }
    body.dark-mode .sidebar .nav-link.active {
      background-color: #0d6efd;
      color: #fff;
    }
    body.dark-mode .card {
      background-color: #1e1e1e;
      border-color: #333;
      color: #e0e0e0;
    }
    body.dark-mode .table {
      color: #e0e0e0;
    }
    body.dark-mode .table thead {
      background-color: #2a2a2a;
    }
    body.dark-mode .table-striped>tbody>tr:nth-of-type(odd)>* {
      --bs-table-accent-bg: #181818;
      color: #e0e0e0;
    }
    body.dark-mode .form-control,
    body.dark-mode .form-select,
    body.dark-mode textarea {
      background-color: #1e1e1e;
      color: #e0e0e0;
      border-color: #444;
    }
    body.dark-mode .form-control:focus,
    body.dark-mode .form-select:focus,
    body.dark-mode textarea:focus {
      background-color: #1e1e1e;
      color: #e0e0e0;
      border-color: #666;
    }
    body.dark-mode .modal-content {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }
    body.dark-mode .navbar {
      background-color: #1e1e1e !important;
    }
    body.dark-mode .btn-outline-light {
      border-color: #e0e0e0;
      color: #e0e0e0;
    }
  </style>
</head>
<body>
<div class="app-container d-flex">
  <!-- Sidebar -->
  <div class="sidebar d-flex flex-column p-3">
    <div class="d-flex align-items-center mb-3">
      <i class="bi bi-droplet-half fs-4 me-2"></i>
      <span class="fw-bold">Pompanisasi</span>
    </div>
    <hr>
    <nav class="nav nav-pills flex-column mb-auto" id="side-nav">
      <a class="nav-link active" href="#" data-section="dashboard">
        <i class="bi bi-speedometer2 me-2"></i>Dashboard
      </a>
      <div class="mt-2 mb-1 text-uppercase text-small text-muted">Master</div>
      <a class="nav-link" href="#" data-section="master-petani">
        <i class="bi bi-person-lines-fill me-2"></i>Petani
      </a>
      <a class="nav-link" href="#" data-section="master-pengepul">
        <i class="bi bi-people-fill me-2"></i>Pengepul
      </a>
      <div class="mt-3 mb-1 text-uppercase text-small text-muted">Transaksi</div>
      <a class="nav-link" href="#" data-section="transaksi-petani">
        <i class="bi bi-diagram-3 me-2"></i>Pembagian Hasil
      </a>
      <a class="nav-link" href="#" data-section="transaksi-pengepul">
        <i class="bi bi-truck me-2"></i>Penjualan Pengepul
      </a>
      <a class="nav-link" href="#" data-section="biaya">
        <i class="bi bi-cash-coin me-2"></i>Biaya Operasional
      </a>
      <div class="mt-3 mb-1 text-uppercase text-small text-muted">Laporan & Data</div>
      <a class="nav-link" href="#" data-section="laporan">
        <i class="bi bi-clipboard-data me-2"></i>Laporan
      </a>
      <a class="nav-link" href="#" data-section="backup">
        <i class="bi bi-hdd-stack me-2"></i>Backup & Restore
      </a>
    </nav>
    <hr>
    <div class="mt-auto">
      <button id="btn-dark-mode" class="btn btn-sm btn-outline-secondary w-100">
        <i class="bi bi-moon-stars me-1"></i><span>Dark Mode</span>
      </button>
    </div>
  </div>

  <!-- Content -->
  <div class="flex-grow-1 d-flex flex-column">
    <!-- Top bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h6">
          Pembukuan Usaha Pompanisasi
        </span>
        <span class="text-muted text-small">
          Pencatatan bagi hasil petani, penjualan ke pengepul, dan biaya operasional
        </span>
      </div>
    </nav>

    <!-- Content area -->
    <div class="content-area">
      <!-- Dashboard -->
      <section id="section-dashboard" class="section active">
        <div class="row g-2 mb-3">
          <div class="col-md-3">
            <label class="form-label text-small">Tanggal Mulai</label>
            <input type="date" id="dash-start" class="form-control form-control-sm">
          </div>
          <div class="col-md-3">
            <label class="form-label text-small">Tanggal Akhir</label>
            <input type="date" id="dash-end" class="form-control form-control-sm">
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary btn-sm w-100" id="btn-filter-dashboard">
              <i class="bi bi-search me-1"></i>Filter
            </button>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-secondary btn-sm w-100" id="btn-reset-dashboard">
              Reset
            </button>
          </div>
        </div>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="text-muted text-small">Total Pemasukan (Penjualan)</div>
                    <div id="dash-total-pemasukan" class="fs-5 fw-bold">Rp 0</div>
                  </div>
                  <i class="bi bi-graph-up-arrow fs-2 text-success"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="text-muted text-small">Total Biaya Operasional</div>
                    <div id="dash-total-biaya" class="fs-5 fw-bold">Rp 0</div>
                  </div>
                  <i class="bi bi-wallet2 fs-2 text-danger"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="text-muted text-small">Laba / Rugi</div>
                    <div id="dash-laba-rugi" class="fs-5 fw-bold">Rp 0</div>
                  </div>
                  <i class="bi bi-cash-coin fs-2 text-primary"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted text-small mb-1">Total Hasil Pompa (Karung)</div>
                <div id="dash-bagi-pompa" class="fs-5 fw-bold">0 Karung</div>
                <div class="text-small text-muted mt-1">
                  Akumulasi hasil panen yang menjadi jatah usaha pompa (karung).
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted text-small mb-1">Total Hasil Petani (Karung)</div>
                <div id="dash-bagi-petani" class="fs-5 fw-bold">0 Karung</div>
                <div class="text-small text-muted mt-1">
                  Akumulasi hasil panen yang menjadi jatah petani (karung).
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Master Petani -->
      <section id="section-master-petani" class="section">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-semibold"><i class="bi bi-person-plus me-1"></i>Tambah Petani</span>
          </div>
          <div class="card-body">
            <form id="form-petani" class="row g-2">
              <div class="col-md-3">
                <label class="form-label text-small">Nama Petani</label>
                <input type="text" id="petani-nama" class="form-control form-control-sm" required>
              </div>
              <div class="col-md-4">
                <label class="form-label text-small">Catatan</label>
                <input type="text" id="petani-catatan" class="form-control form-control-sm">
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Foto KTP Petani</label>
                <input type="file" id="petani-foto" accept="image/*" class="form-control form-control-sm">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                  <i class="bi bi-plus-circle me-1"></i>Simpan
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header fw-semibold">
            Daftar Petani
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                <tr>
                  <th style="width:40px;">#</th>
                  <th>Nama</th>
                  <th>Foto KTP</th>
                  <th>Catatan</th>
                  <th style="width:140px;">Aksi</th>
                </tr>
                </thead>
                <tbody id="table-petani-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Master Pengepul -->
      <section id="section-master-pengepul" class="section">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-semibold"><i class="bi bi-person-plus me-1"></i>Tambah Pengepul</span>
          </div>
          <div class="card-body">
            <form id="form-pengepul" class="row g-2">
              <div class="col-md-4">
                <label class="form-label text-small">Nama Pengepul</label>
                <input type="text" id="pengepul-nama" class="form-control form-control-sm" required>
              </div>
              <div class="col-md-6">
                <label class="form-label text-small">Catatan</label>
                <input type="text" id="pengepul-catatan" class="form-control form-control-sm">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                  <i class="bi bi-plus-circle me-1"></i>Simpan
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header fw-semibold">
            Daftar Pengepul
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                <tr>
                  <th style="width:40px;">#</th>
                  <th>Nama</th>
                  <th>Catatan</th>
                  <th style="width:140px;">Aksi</th>
                </tr>
                </thead>
                <tbody id="table-pengepul-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Transaksi Pembagian Hasil -->
      <section id="section-transaksi-petani" class="section">
        <div class="card mb-3">
          <div class="card-header fw-semibold">
            Input Transaksi Pembagian Hasil dari Petani
          </div>
          <div class="card-body">
            <form id="form-transaksi-petani" class="row g-2">
              <div class="col-md-2">
                <label class="form-label text-small">Tanggal</label>
                <input type="date" id="tp-tanggal" class="form-control form-control-sm" required>
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Petani</label>
                <select id="tp-petani-id" class="form-select form-select-sm" required></select>
              </div>
              <div class="col-md-2">
                <label class="form-label text-small">Jumlah Karung Panen</label>
                <input type="number" id="tp-karung" step="0.01" inputmode="decimal" class="form-control form-control-sm">
              </div>
              <div class="col-md-2">
                <label class="form-label text-small">Jumlah Pupuk</label>
                <input type="number" id="tp-pupuk" step="0.01" inputmode="decimal" class="form-control form-control-sm">
              </div>
              <div class="col-md-2">
                <label class="form-label text-small">Hasil Pompa (Karung)</label>
                <input type="number" id="tp-hasil-pompa" step="0.01" inputmode="decimal" class="form-control form-control-sm">
              </div>
              <div class="col-md-2">
                <label class="form-label text-small">Hasil Petani (Karung)</label>
                <input type="number" id="tp-hasil-petani" step="0.01" inputmode="decimal" class="form-control form-control-sm">
              </div>
              <div class="col-md-8">
                <label class="form-label text-small">Keterangan</label>
                <textarea id="tp-keterangan" class="form-control form-control-sm" rows="1"></textarea>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                  <i class="bi bi-plus-circle me-1"></i>Simpan Transaksi
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header fw-semibold">
            Daftar Transaksi Pembagian Hasil
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                <tr>
                  <th style="width:40px;">#</th>
                  <th>Tanggal</th>
                  <th>Petani</th>
                  <th class="text-end">Karung Panen</th>
                  <th class="text-end">Pupuk</th>
                  <th class="text-end">Hasil Pompa</th>
                  <th class="text-end">Hasil Petani</th>
                  <th>Keterangan</th>
                  <th style="width:140px;">Aksi</th>
                </tr>
                </thead>
                <tbody id="table-transaksi-petani-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Transaksi Penjualan ke Pengepul -->
      <section id="section-transaksi-pengepul" class="section">
        <div class="card mb-3">
          <div class="card-header fw-semibold">
            Input Penjualan ke Pengepul
          </div>
          <div class="card-body">
            <form id="form-transaksi-pengepul" class="row g-2">
              <div class="col-md-2">
                <label class="form-label text-small">Tanggal</label>
                <input type="date" id="tpen-tanggal" class="form-control form-control-sm" required>
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Pengepul</label>
                <select id="tpen-pengepul-id" class="form-select form-select-sm" required></select>
              </div>
              <div class="col-md-2">
                <label class="form-label text-small">Jumlah Karung</label>
                <input type="number" id="tpen-karung" step="0.01" inputmode="decimal" class="form-control form-control-sm">
              </div>
              <div class="col-md-2">
                <label class="form-label text-small">Total Berat (Kg)</label>
                <input type="number" id="tpen-totalkg" step="0.01" inputmode="decimal" class="form-control form-control-sm">
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Harga per Kg (Rp)</label>
                <input type="number" id="tpen-harga-kg" step="0.01" inputmode="decimal" class="form-control form-control-sm">
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Total Harga (Rp)</label>
                <input type="number" id="tpen-total-harga" class="form-control form-control-sm" readonly>
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Status Pembayaran</label>
                <select id="tpen-status" class="form-select form-select-sm">
                  <option value="Lunas">Lunas</option>
                  <option value="Belum Lunas">Belum Lunas</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Metode Pembayaran</label>
                <select id="tpen-metode" class="form-select form-select-sm">
                  <option value="Tunai">Tunai</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label text-small">Foto Bukti Pembayaran</label>
                <input type="file" id="tpen-foto" accept="image/*" class="form-control form-control-sm">
              </div>
              <div class="col-md-12">
                <label class="form-label text-small">Keterangan</label>
                <textarea id="tpen-keterangan" class="form-control form-control-sm" rows="1"></textarea>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                  <i class="bi bi-plus-circle me-1"></i>Simpan Penjualan
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header fw-semibold">
            Daftar Penjualan ke Pengepul
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                <tr>
                  <th style="width:40px;">#</th>
                  <th>Tanggal</th>
                  <th>Pengepul</th>
                  <th class="text-end">Karung</th>
                  <th class="text-end">Total Kg</th>
                  <th class="text-end">Harga/Kg</th>
                  <th class="text-end">Total Harga</th>
                  <th>Status</th>
                  <th>Metode</th>
                  <th>Bukti</th>
                  <th>Keterangan</th>
                  <th style="width:140px;">Aksi</th>
                </tr>
                </thead>
                <tbody id="table-transaksi-pengepul-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Biaya Operasional -->
      <section id="section-biaya" class="section">
        <div class="card mb-3">
          <div class="card-header fw-semibold">
            Input Biaya Operasional
          </div>
          <div class="card-body">
            <form id="form-biaya" class="row g-2">
              <div class="col-md-2">
                <label class="form-label text-small">Tanggal</label>
                <input type="date" id="biaya-tanggal" class="form-control form-control-sm" required>
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Kategori</label>
                <select id="biaya-kategori" class="form-select form-select-sm">
                  <option>Solar</option>
                  <option>Listrik Pompa</option>
                  <option>Service</option>
                  <option>Gaji Karyawan</option>
                  <option>Gaji Pelaksana</option>
                  <option>Lain-lain</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label text-small">Deskripsi</label>
                <input type="text" id="biaya-deskripsi" class="form-control form-control-sm">
              </div>
              <div class="col-md-2">
                <label class="form-label text-small">Nominal (Rp)</label>
                <input type="number" id="biaya-nominal" class="form-control form-control-sm" required>
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Bukti Biaya</label>
                <input type="file" id="biaya-foto" accept="image/*" class="form-control form-control-sm">
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                  <i class="bi bi-plus-circle"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="card">
          <div class="card-header fw-semibold">
            Daftar Biaya Operasional
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                <tr>
                  <th style="width:40px;">#</th>
                  <th>Tanggal</th>
                  <th>Kategori</th>
                  <th>Deskripsi</th>
                  <th class="text-end">Nominal</th>
                  <th class="text-center">Bukti</th>
                  <th style="width:140px;">Aksi</th>
                </tr>
                </thead>
                <tbody id="table-biaya-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Laporan -->
      <section id="section-laporan" class="section">
        <div class="card mb-3">
          <div class="card-header fw-semibold">
            Laporan Laba / Rugi
          </div>
          <div class="card-body">
            <form id="form-laporan" class="row g-2">
              <!-- <div class="col-md-3">
                <label class="form-label text-small">Periode (Bulan)</label>
                <input type="month" id="laporan-bulan" class="form-control form-control-sm">
              </div> -->
              <div class="col-md-3">
                <label class="form-label text-small">Tanggal Mulai</label>
                <input type="date" id="laporan-start" class="form-control form-control-sm">
              </div>
              <div class="col-md-3">
                <label class="form-label text-small">Tanggal Akhir</label>
                <input type="date" id="laporan-end" class="form-control form-control-sm">
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button type="button" id="btn-hitung-laporan" class="btn btn-primary btn-sm">
                  <i class="bi bi-calculator me-1"></i>Hitung Laporan
                </button>
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <div class="text-small text-muted">
                  Jika periode kosong, laporan akan menghitung semua data yang ada.
                </div>
              </div>
            </form>
          </div>
        </div>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <div class="text-muted text-small">Pemasukan (Penjualan)</div>
                <div id="lap-total-pemasukan" class="fs-5 fw-bold">Rp 0</div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <div class="text-muted text-small">Biaya Operasional</div>
                <div id="lap-total-biaya" class="fs-5 fw-bold">Rp 0</div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <div class="text-muted text-small">Laba / Rugi</div>
                <div id="lap-laba-rugi" class="fs-5 fw-bold">Rp 0</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Backup & Restore -->
      <section id="section-backup" class="section">
        <div class="card mb-3">
          <div class="card-header fw-semibold">
            Backup & Restore (JSON)
          </div>
          <div class="card-body">
            <div class="mb-2">
              <button id="btn-export-json" class="btn btn-sm btn-outline-primary me-2">
                <i class="bi bi-file-earmark-arrow-down me-1"></i>Export JSON
              </button>
            </div>
            <div class="mb-2">
              <label class="form-label text-small mb-1">Import JSON (akan menimpa data lama)</label>
              <input type="file" id="input-import-json" class="form-control form-control-sm" accept="application/json">
            </div>
            <div class="text-small text-muted">
              File JSON berisi semua master dan transaksi (petani, pengepul, pembagian hasil, penjualan, biaya).
              Foto tidak ikut (disimpan di IndexedDB lokal).
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header fw-semibold">
            Export & Import Excel
          </div>
          <div class="card-body">
            <div class="mb-2">
              <button id="btn-export-excel" class="btn btn-sm btn-success me-2">
                <i class="bi bi-file-earmark-excel me-1"></i>Export Excel (.xlsx)
              </button>
            </div>
            <div class="mb-2">
              <label class="form-label text-small mb-1">Import Excel (.xlsx) dari aplikasi ini</label>
              <input type="file" id="input-import-excel" class="form-control form-control-sm"
                     accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel">
            </div>
            <div class="text-small text-muted">
              Format sheet:
              <code>petani</code>, <code>pengepul</code>, <code>transaksi_petani</code>,
              <code>penjualan_pengepul</code>, <code>biaya</code>.
              Import akan menimpa seluruh data jika berhasil dibaca. Foto tidak ikut.
            </div>
          </div>
        </div>
        <hr class="my-3">
        <button id="btn-clear-data" class="btn btn-danger btn-sm">
          Hapus Semua Data
        </button>
        <p class="text-danger small mt-2">
          Perhatian: Menghapus semua data akan memulai aplikasi dari awal dan tidak bisa dibatalkan.
          (Termasuk menghapus semua foto di IndexedDB).
        </p>
      </section>
    </div>
  </div>
</div>

<!-- Modal Edit Petani -->
<div class="modal fade" id="modalEditPetani" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" id="form-edit-petani">
      <div class="modal-header">
        <h5 class="modal-title">Edit Petani</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-petani-id">
        <div class="mb-2">
          <label class="form-label text-small">Nama Petani</label>
          <input type="text" id="edit-petani-nama" class="form-control form-control-sm" required>
        </div>
        <div class="mb-2">
          <label class="form-label text-small">Catatan</label>
          <input type="text" id="edit-petani-catatan" class="form-control form-control-sm">
        </div>
        <div class="mb-2">
          <label class="form-label text-small">Foto KTP</label>
          <input type="file" id="edit-petani-foto" accept="image/*" class="form-control form-control-sm">
          <img id="preview-edit-petani-foto" src="" style="height:80px;margin-top:6px;border-radius:6px;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" class="btn btn-sm btn-primary">Simpan Perubahan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Edit Pengepul -->
<div class="modal fade" id="modalEditPengepul" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" id="form-edit-pengepul">
      <div class="modal-header">
        <h5 class="modal-title">Edit Pengepul</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-pengepul-id">
        <div class="mb-2">
          <label class="form-label text-small">Nama Pengepul</label>
          <input type="text" id="edit-pengepul-nama" class="form-control form-control-sm" required>
        </div>
        <div class="mb-2">
          <label class="form-label text-small">Catatan</label>
          <input type="text" id="edit-pengepul-catatan" class="form-control form-control-sm">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" class="btn btn-sm btn-primary">Simpan Perubahan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Edit Transaksi Pembagian Hasil -->
<div class="modal fade" id="modalEditTransaksiPetani" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form class="modal-content" id="form-edit-transaksi-petani">
      <div class="modal-header">
        <h5 class="modal-title">Edit Transaksi Pembagian Hasil</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body row g-2">
        <input type="hidden" id="edit-tp-id">
        <div class="col-md-3">
          <label class="form-label text-small">Tanggal</label>
          <input type="date" id="edit-tp-tanggal" class="form-control form-control-sm" required>
        </div>
        <div class="col-md-4">
          <label class="form-label text-small">Petani</label>
          <select id="edit-tp-petani-id" class="form-select form-select-sm" required></select>
        </div>
        <div class="col-md-2">
          <label class="form-label text-small">Karung Panen</label>
          <input type="number" id="edit-tp-karung" step="0.01" inputmode="decimal" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Jumlah Pupuk</label>
          <input type="number" id="edit-tp-pupuk" step="0.01" inputmode="decimal" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Hasil Pompa (Karung)</label>
          <input type="number" id="edit-tp-hasil-pompa" step="0.01" inputmode="decimal" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Hasil Petani (Karung)</label>
          <input type="number" id="edit-tp-hasil-petani" step="0.01" inputmode="decimal" class="form-control form-control-sm">
        </div>
        <div class="col-md-9">
          <label class="form-label text-small">Keterangan</label>
          <textarea id="edit-tp-keterangan" class="form-control form-control-sm" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" class="btn btn-sm btn-primary">Simpan Perubahan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Edit Penjualan ke Pengepul -->
<div class="modal fade" id="modalEditPenjualanPengepul" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form class="modal-content" id="form-edit-penjualan-pengepul">
      <div class="modal-header">
        <h5 class="modal-title">Edit Penjualan ke Pengepul</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body row g-2">
        <input type="hidden" id="edit-tpen-id">
        <div class="col-md-3">
          <label class="form-label text-small">Tanggal</label>
          <input type="date" id="edit-tpen-tanggal" class="form-control form-control-sm" required>
        </div>
        <div class="col-md-4">
          <label class="form-label text-small">Pengepul</label>
          <select id="edit-tpen-pengepul-id" class="form-select form-select-sm" required></select>
        </div>
        <div class="col-md-2">
          <label class="form-label text-small">Karung</label>
          <input type="number" id="edit-tpen-karung" step="0.01" inputmode="decimal" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Total Kg</label>
          <input type="number" id="edit-tpen-totalkg" step="0.01" inputmode="decimal" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Harga/Kg (Rp)</label>
          <input type="number" id="edit-tpen-harga-kg" step="0.01" inputmode="decimal" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Total Harga (Rp)</label>
          <input type="number" id="edit-tpen-total-harga" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Status Pembayaran</label>
          <select id="edit-tpen-status" class="form-select form-select-sm">
            <option value="Lunas">Lunas</option>
            <option value="Belum Lunas">Belum Lunas</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Metode</label>
          <select id="edit-tpen-metode" class="form-select form-select-sm">
            <option value="Tunai">Tunai</option>
            <option value="Transfer">Transfer</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Foto Bukti Pembayaran</label>
          <input type="file" id="edit-tpen-foto" accept="image/*" class="form-control form-control-sm">
          <img id="preview-edit-tpen-foto" src="" style="height:80px;margin-top:6px;border-radius:6px;">
        </div>
        <div class="col-md-9">
          <label class="form-label text-small">Keterangan</label>
          <textarea id="edit-tpen-keterangan" class="form-control form-control-sm" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" class="btn btn-sm btn-primary">Simpan Perubahan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Edit Biaya -->
<div class="modal fade" id="modalEditBiaya" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form class="modal-content" id="form-edit-biaya">
      <div class="modal-header">
        <h5 class="modal-title">Edit Biaya Operasional</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body row g-2">
        <input type="hidden" id="edit-biaya-id">
        <div class="col-md-3">
          <label class="form-label text-small">Tanggal</label>
          <input type="date" id="edit-biaya-tanggal" class="form-control form-control-sm" required>
        </div>
        <div class="col-md-3">
          <label class="form-label text-small">Kategori</label>
          <select id="edit-biaya-kategori" class="form-select form-select-sm">
            <option>Solar</option>
            <option>Listrik Pompa</option>
            <option>Service</option>
            <option>Gaji Karyawan</option>
            <option>Gaji Pelaksana</option>
            <option>Lain-lain</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label text-small">Deskripsi</label>
          <input type="text" id="edit-biaya-deskripsi" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
          <label class="form-label text-small">Nominal (Rp)</label>
          <input type="number" id="edit-biaya-nominal" class="form-control form-control-sm" required>
        </div>
        <div class="mb-2">
          <label class="form-label text-small">Bukti Biaya</label>
          <input type="file" id="edit-biaya-foto" accept="image/*" class="form-control form-control-sm">
          <img id="preview-edit-biaya-foto" src="" style="height:70px;margin-top:5px;border-radius:4px;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" class="btn btn-sm btn-primary">Simpan Perubahan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Preview Foto -->
<div class="modal fade" id="modalPreviewFoto" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-0">
        <h5 class="modal-title">Preview Foto</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="previewFotoImg" src="" style="max-width:100%; border-radius:8px;">
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const STORAGE_KEY = 'pembukuan_pompanisasi_data_v4';
  const DARK_MODE_KEY = 'pembukuan_pompanisasi_dark_mode';
  const PHOTO_DB_NAME = 'pompanisasi_photos_db';
  const PHOTO_DB_VERSION = 1;

  let photoDBPromise = null;

  function getPhotoDB() {
    if (!('indexedDB' in window)) {
      console.warn('IndexedDB tidak tersedia. Foto tidak akan disimpan.');
      return Promise.reject('IndexedDB not supported');
    }
    if (!photoDBPromise) {
      photoDBPromise = new Promise((resolve, reject) => {
        const req = indexedDB.open(PHOTO_DB_NAME, PHOTO_DB_VERSION);
        req.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('petaniPhotos')) {
            db.createObjectStore('petaniPhotos', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('penjualanPhotos')) {
            db.createObjectStore('penjualanPhotos', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('biayaPhotos')) {
            db.createObjectStore('biayaPhotos', { keyPath: 'id' });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    return photoDBPromise;
  }

  function savePhoto(storeName, id, file) {
    if (!file) return Promise.resolve();
    return getPhotoDB().then(db => new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      store.put({ id, blob: file, updatedAt: Date.now() });
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    })).catch(err => {
      console.error('Gagal simpan foto ke IndexedDB', err);
    });
  }

  function deletePhoto(storeName, id) {
    return getPhotoDB().then(db => new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      store.delete(id);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    })).catch(err => {
      console.error('Gagal hapus foto dari IndexedDB', err);
    });
  }

  function getPhoto(storeName, id) {
    return getPhotoDB().then(db => new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.get(id);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => reject(req.error);
    })).catch(err => {
      console.error('Gagal ambil foto dari IndexedDB', err);
      return null;
    });
  }

  function loadAllThumbnails() {
    const imgs = document.querySelectorAll('img[data-photo-store][data-photo-id]');
    imgs.forEach(img => {
      const store = img.getAttribute('data-photo-store');
      const id = Number(img.getAttribute('data-photo-id'));
      getPhoto(store, id).then(rec => {
        if (rec && rec.blob) {
          const url = URL.createObjectURL(rec.blob);
          img.src = url;
          img.setAttribute('data-foto', url);
        }
      });
    });
  }

  function getDefaultData() {
    return {
      petani: [],
      pengepul: [],
      transaksiPetani: [],
      penjualanPengepul: [],
      biaya: []
    };
  }

  let data = loadData();

  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return getDefaultData();
    try {
      const obj = JSON.parse(raw);
      return Object.assign(getDefaultData(), obj);
    } catch (e) {
      console.error('Gagal parse data, pakai default.', e);
      return getDefaultData();
    }
  }

  function cleanLegacyBase64() {
    // Hapus base64 yang lama kalau masih ada di data
    data.petani.forEach(p => {
      if (p.fotoKTP && typeof p.fotoKTP === 'string' && p.fotoKTP.startsWith('data:')) {
        p.fotoKTP = true; // tandai saja ada foto, data fisik diabaikan
      }
    });
    data.penjualanPengepul.forEach(t => {
      if (t.fotoBukti && typeof t.fotoBukti === 'string' && t.fotoBukti.startsWith('data:')) {
        t.fotoBukti = true;
      }
    });
    data.biaya.forEach(b => {
      if (b.fotoBukti && typeof b.fotoBukti === 'string' && b.fotoBukti.startsWith('data:')) {
        b.fotoBukti = true;
      }
    });
  }

  function saveData() {
    cleanLegacyBase64();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    updateAllUI();
  }

  function formatRupiah(num) {
    if (!num) num = 0;
    const sign = num < 0 ? '-' : '';
    num = Math.abs(num);
    return sign + 'Rp ' + num.toLocaleString('id-ID');
  }

  function formatDateID(iso) {
    if (!iso) return '';
    const parts = iso.split('-');
    if (parts.length !== 3) return iso;
    return parts[2] + '/' + parts[1] + '/' + parts[0];
  }

  function toNumber(val) {
    if (val === null || val === undefined || val === '') return 0;
    return Number(val.toString().replace(',', '.')) || 0;
  }

  // Navigation
  document.querySelectorAll('#side-nav .nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const target = link.dataset.section;
      document.querySelectorAll('#side-nav .nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      const sec = document.getElementById('section-' + target);
      if (sec) sec.classList.add('active');
    });
  });

  // Dark mode
  function applyDarkModeFromStorage() {
    const val = localStorage.getItem(DARK_MODE_KEY);
    const isDark = val === '1';
    document.body.classList.toggle('dark-mode', isDark);
    const btn = document.getElementById('btn-dark-mode');
    if (btn) {
      const span = btn.querySelector('span');
      if (span) span.textContent = isDark ? 'Light Mode' : 'Dark Mode';
      btn.classList.toggle('btn-outline-light', isDark);
      btn.classList.toggle('btn-outline-secondary', !isDark);
    }
  }

  document.getElementById('btn-dark-mode').addEventListener('click', () => {
    const isDark = !document.body.classList.contains('dark-mode');
    document.body.classList.toggle('dark-mode', isDark);
    localStorage.setItem(DARK_MODE_KEY, isDark ? '1' : '0');
    applyDarkModeFromStorage();
  });

  applyDarkModeFromStorage();

  // Preview foto (thumbnail -> modal)
  function attachPreviewEvents() {
    document.querySelectorAll('.foto-thumb').forEach(img => {
      img.onclick = () => {
        const src = img.getAttribute('data-foto') || img.src;
        document.getElementById('previewFotoImg').src = src;
        new bootstrap.Modal(document.getElementById('modalPreviewFoto')).show();
      };
    });
  }

  // Master Petani
  document.getElementById('form-petani').addEventListener('submit', (e) => {
    e.preventDefault();
    const nama = document.getElementById('petani-nama').value.trim();
    const catatan = document.getElementById('petani-catatan').value.trim();
    const file = document.getElementById('petani-foto').files[0];
    if (!nama) return;
    const newId = Date.now();

    function finalize(hasFoto) {
      data.petani.push({
        id: newId,
        nama,
        catatan,
        fotoKTP: !!hasFoto
      });
      document.getElementById('petani-nama').value = '';
      document.getElementById('petani-catatan').value = '';
      document.getElementById('petani-foto').value = '';
      saveData();
    }

    if (file) {
      savePhoto('petaniPhotos', newId, file).then(() => finalize(true));
    } else {
      finalize(false);
    }
  });

  function renderPetani() {
    const tbody = document.getElementById('table-petani-body');
    tbody.innerHTML = '';
    data.petani.forEach((p, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${p.nama}</td>
        <td>
          ${p.fotoKTP
            ? `<img class="foto-thumb" data-photo-store="petaniPhotos" data-photo-id="${p.id}"
                     style="height:45px;cursor:pointer;border-radius:5px;">`
            : '-'}
        </td>
        <td>${p.catatan || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary btn-edit-petani me-1" data-id="${p.id}">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger btn-del-petani" data-id="${p.id}">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('.btn-del-petani').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        if (!confirm('Hapus petani ini? Transaksi yang terkait juga akan dihapus.')) return;
        const petani = data.petani.find(p => p.id === id);
        if (petani && petani.fotoKTP) {
          deletePhoto('petaniPhotos', id);
        }
        data.petani = data.petani.filter(p => p.id !== id);
        data.transaksiPetani = data.transaksiPetani.filter(t => t.petaniId !== id);
        saveData();
      });
    });

    tbody.querySelectorAll('.btn-edit-petani').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        const p = data.petani.find(x => x.id === id);
        if (!p) return;
        document.getElementById('edit-petani-id').value = p.id;
        document.getElementById('edit-petani-nama').value = p.nama;
        document.getElementById('edit-petani-catatan').value = p.catatan || '';
        document.getElementById('edit-petani-foto').value = '';
        const imgPrev = document.getElementById('preview-edit-petani-foto');
        imgPrev.src = '';
        if (p.fotoKTP) {
          getPhoto('petaniPhotos', p.id).then(rec => {
            if (rec && rec.blob) {
              imgPrev.src = URL.createObjectURL(rec.blob);
            }
          });
        }
        new bootstrap.Modal(document.getElementById('modalEditPetani')).show();
      });
    });

    // dropdown petani
    const selAdd = document.getElementById('tp-petani-id');
    const selEdit = document.getElementById('edit-tp-petani-id');
    selAdd.innerHTML = '<option value="">-- Pilih Petani --</option>';
    selEdit.innerHTML = '<option value="">-- Pilih Petani --</option>';
    data.petani.forEach(p => {
      const opt1 = document.createElement('option');
      opt1.value = p.id;
      opt1.textContent = p.nama;
      selAdd.appendChild(opt1);
      const opt2 = document.createElement('option');
      opt2.value = p.id;
      opt2.textContent = p.nama;
      selEdit.appendChild(opt2);
    });

    loadAllThumbnails();
    attachPreviewEvents();
  }

  document.getElementById('form-edit-petani').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = Number(document.getElementById('edit-petani-id').value);
    const nama = document.getElementById('edit-petani-nama').value.trim();
    const catatan = document.getElementById('edit-petani-catatan').value.trim();
    const file = document.getElementById('edit-petani-foto').files[0];
    const idx = data.petani.findIndex(p => p.id === id);
    if (idx < 0) return;
    data.petani[idx].nama = nama;
    data.petani[idx].catatan = catatan;

    function doneSave(hasFoto) {
      if (hasFoto !== null) data.petani[idx].fotoKTP = hasFoto;
      saveData();
      bootstrap.Modal.getInstance(document.getElementById('modalEditPetani')).hide();
    }

    if (file) {
      savePhoto('petaniPhotos', id, file).then(() => doneSave(true));
    } else {
      // tidak ubah foto
      doneSave(null);
    }
  });

  // Master Pengepul
  document.getElementById('form-pengepul').addEventListener('submit', (e) => {
    e.preventDefault();
    const nama = document.getElementById('pengepul-nama').value.trim();
    const catatan = document.getElementById('pengepul-catatan').value.trim();
    if (!nama) return;
    data.pengepul.push({ id: Date.now(), nama, catatan });
    document.getElementById('pengepul-nama').value = '';
    document.getElementById('pengepul-catatan').value = '';
    saveData();
  });

  function renderPengepul() {
    const tbody = document.getElementById('table-pengepul-body');
    tbody.innerHTML = '';
    data.pengepul.forEach((p, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${p.nama}</td>
        <td>${p.catatan || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary btn-edit-pengepul me-1" data-id="${p.id}">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger btn-del-pengepul" data-id="${p.id}">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('.btn-del-pengepul').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        if (!confirm('Hapus pengepul ini? Penjualan yang terkait juga akan dihapus.')) return;
        data.pengepul = data.pengepul.filter(p => p.id !== id);
        // hapus foto penjualan terkait
        data.penjualanPengepul.forEach(t => {
          if (t.pengepulId === id && t.fotoBukti) {
            deletePhoto('penjualanPhotos', t.id);
          }
        });
        data.penjualanPengepul = data.penjualanPengepul.filter(t => t.pengepulId !== id);
        saveData();
      });
    });

    tbody.querySelectorAll('.btn-edit-pengepul').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        const p = data.pengepul.find(x => x.id === id);
        if (!p) return;
        document.getElementById('edit-pengepul-id').value = p.id;
        document.getElementById('edit-pengepul-nama').value = p.nama;
        document.getElementById('edit-pengepul-catatan').value = p.catatan || '';
        new bootstrap.Modal(document.getElementById('modalEditPengepul')).show();
      });
    });

    // dropdown pengepul
    const selAdd = document.getElementById('tpen-pengepul-id');
    const selEdit = document.getElementById('edit-tpen-pengepul-id');
    selAdd.innerHTML = '<option value="">-- Pilih Pengepul --</option>';
    selEdit.innerHTML = '<option value="">-- Pilih Pengepul --</option>';
    data.pengepul.forEach(p => {
      const opt1 = document.createElement('option');
      opt1.value = p.id;
      opt1.textContent = p.nama;
      selAdd.appendChild(opt1);
      const opt2 = document.createElement('option');
      opt2.value = p.id;
      opt2.textContent = p.nama;
      selEdit.appendChild(opt2);
    });
  }

  document.getElementById('form-edit-pengepul').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = Number(document.getElementById('edit-pengepul-id').value);
    const nama = document.getElementById('edit-pengepul-nama').value.trim();
    const catatan = document.getElementById('edit-pengepul-catatan').value.trim();
    const idx = data.pengepul.findIndex(p => p.id === id);
    if (idx >= 0) {
      data.pengepul[idx].nama = nama;
      data.pengepul[idx].catatan = catatan;
      saveData();
      bootstrap.Modal.getInstance(document.getElementById('modalEditPengepul')).hide();
    }
  });

  // Transaksi Pembagian Hasil
  document.getElementById('form-transaksi-petani').addEventListener('submit', (e) => {
    e.preventDefault();
    const tanggal = document.getElementById('tp-tanggal').value;
    const petaniId = Number(document.getElementById('tp-petani-id').value);
    const jumlahKarungPanen = toNumber(document.getElementById('tp-karung').value);
    const jumlahPupuk = toNumber(document.getElementById('tp-pupuk').value);
    const hasilPompaKarung = toNumber(document.getElementById('tp-hasil-pompa').value);
    const hasilPetaniKarung = toNumber(document.getElementById('tp-hasil-petani').value);
    const ket = document.getElementById('tp-keterangan').value.trim();
    if (!tanggal || !petaniId) return;
    data.transaksiPetani.push({
      id: Date.now(),
      tanggal,
      petaniId,
      jumlahKarungPanen,
      jumlahPupuk,
      hasilPompaKarung,
      hasilPetaniKarung,
      keterangan: ket
    });
    document.getElementById('tp-tanggal').value = '';
    document.getElementById('tp-petani-id').value = '';
    document.getElementById('tp-karung').value = '';
    document.getElementById('tp-pupuk').value = '';
    document.getElementById('tp-hasil-pompa').value = '';
    document.getElementById('tp-hasil-petani').value = '';
    document.getElementById('tp-keterangan').value = '';
    saveData();
  });

  function renderTransaksiPetani() {
    const tbody = document.getElementById('table-transaksi-petani-body');
    tbody.innerHTML = '';
    data.transaksiPetani
      .slice()
      .sort((a,b) => a.tanggal.localeCompare(b.tanggal))
      .forEach((t, idx) => {
        const petani = data.petani.find(p => p.id === t.petaniId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${formatDateID(t.tanggal)}</td>
          <td>${petani ? petani.nama : '-'}</td>
          <td class="text-end">${t.jumlahKarungPanen}</td>
          <td class="text-end">${t.jumlahPupuk}</td>
          <td class="text-end">${t.hasilPompaKarung}</td>
          <td class="text-end">${t.hasilPetaniKarung}</td>
          <td>${t.keterangan || ''}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary btn-edit-tp me-1" data-id="${t.id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger btn-del-tp" data-id="${t.id}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

    tbody.querySelectorAll('.btn-del-tp').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        if (!confirm('Hapus transaksi pembagian hasil ini?')) return;
        data.transaksiPetani = data.transaksiPetani.filter(t => t.id !== id);
        saveData();
      });
    });

    tbody.querySelectorAll('.btn-edit-tp').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        const t = data.transaksiPetani.find(x => x.id === id);
        if (!t) return;
        document.getElementById('edit-tp-id').value = t.id;
        document.getElementById('edit-tp-tanggal').value = t.tanggal;
        document.getElementById('edit-tp-petani-id').value = t.petaniId;
        document.getElementById('edit-tp-karung').value = t.jumlahKarungPanen;
        document.getElementById('edit-tp-pupuk').value = t.jumlahPupuk;
        document.getElementById('edit-tp-hasil-pompa').value = t.hasilPompaKarung;
        document.getElementById('edit-tp-hasil-petani').value = t.hasilPetaniKarung;
        document.getElementById('edit-tp-keterangan').value = t.keterangan || '';
        new bootstrap.Modal(document.getElementById('modalEditTransaksiPetani')).show();
      });
    });
  }

  document.getElementById('form-edit-transaksi-petani').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = Number(document.getElementById('edit-tp-id').value);
    const tanggal = document.getElementById('edit-tp-tanggal').value;
    const petaniId = Number(document.getElementById('edit-tp-petani-id').value);
    const jumlahKarungPanen = toNumber(document.getElementById('edit-tp-karung').value);
    const jumlahPupuk = toNumber(document.getElementById('edit-tp-pupuk').value);
    const hasilPompaKarung = toNumber(document.getElementById('edit-tp-hasil-pompa').value);
    const hasilPetaniKarung = toNumber(document.getElementById('edit-tp-hasil-petani').value);
    const ket = document.getElementById('edit-tp-keterangan').value.trim();
    const idx = data.transaksiPetani.findIndex(t => t.id === id);
    if (idx >= 0) {
      data.transaksiPetani[idx] = {
        id,
        tanggal,
        petaniId,
        jumlahKarungPanen,
        jumlahPupuk,
        hasilPompaKarung,
        hasilPetaniKarung,
        keterangan: ket
      };
      saveData();
      bootstrap.Modal.getInstance(document.getElementById('modalEditTransaksiPetani')).hide();
    }
  });

  // Penjualan ke Pengepul
  function updatePenjualanTotalInput() {
    const totalKg = toNumber(document.getElementById('tpen-totalkg').value);
    const hargaPerKg = toNumber(document.getElementById('tpen-harga-kg').value);
    document.getElementById('tpen-total-harga').value = totalKg * hargaPerKg;
  }
  document.getElementById('tpen-totalkg').addEventListener('input', updatePenjualanTotalInput);
  document.getElementById('tpen-harga-kg').addEventListener('input', updatePenjualanTotalInput);

  document.getElementById('form-transaksi-pengepul').addEventListener('submit', (e) => {
    e.preventDefault();
    const tanggal = document.getElementById('tpen-tanggal').value;
    const pengepulId = Number(document.getElementById('tpen-pengepul-id').value);
    const jumlahKarung = toNumber(document.getElementById('tpen-karung').value);
    const totalKg = toNumber(document.getElementById('tpen-totalkg').value);
    const hargaPerKg = toNumber(document.getElementById('tpen-harga-kg').value);
    const totalHarga = toNumber(document.getElementById('tpen-total-harga').value) || (totalKg * hargaPerKg);
    const statusPembayaran = document.getElementById('tpen-status').value || 'Lunas';
    const metodePembayaran = document.getElementById('tpen-metode').value || 'Tunai';
    const keterangan = document.getElementById('tpen-keterangan').value.trim();
    const fileFoto = document.getElementById('tpen-foto').files[0];

    if (!tanggal || !pengepulId) return;

    const newId = Date.now();

    function pushAndSave(hasFoto) {
      data.penjualanPengepul.push({
        id: newId,
        tanggal,
        pengepulId,
        jumlahKarung,
        totalKg,
        hargaPerKg,
        totalHarga,
        statusPembayaran,
        metodePembayaran,
        keterangan,
        fotoBukti: !!hasFoto
      });
      document.getElementById('tpen-tanggal').value = '';
      document.getElementById('tpen-pengepul-id').value = '';
      document.getElementById('tpen-karung').value = '';
      document.getElementById('tpen-totalkg').value = '';
      document.getElementById('tpen-harga-kg').value = '';
      document.getElementById('tpen-total-harga').value = '';
      document.getElementById('tpen-status').value = 'Lunas';
      document.getElementById('tpen-metode').value = 'Tunai';
      document.getElementById('tpen-keterangan').value = '';
      document.getElementById('tpen-foto').value = '';
      saveData();
    }

    if (fileFoto) {
      savePhoto('penjualanPhotos', newId, fileFoto).then(() => pushAndSave(true));
    } else {
      pushAndSave(false);
    }
  });

  function renderPenjualanPengepul() {
    const tbody = document.getElementById('table-transaksi-pengepul-body');
    tbody.innerHTML = '';
    data.penjualanPengepul
      .slice()
      .sort((a,b) => a.tanggal.localeCompare(b.tanggal))
      .forEach((t, idx) => {
        const pengepul = data.pengepul.find(p => p.id === t.pengepulId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${formatDateID(t.tanggal)}</td>
          <td>${pengepul ? pengepul.nama : '-'}</td>
          <td class="text-end">${t.jumlahKarung}</td>
          <td class="text-end">${t.totalKg}</td>
          <td class="text-end">${formatRupiah(t.hargaPerKg)}</td>
          <td class="text-end">${formatRupiah(t.totalHarga)}</td>
          <td>${t.statusPembayaran}</td>
          <td>${t.metodePembayaran}</td>
          <td>
            ${t.fotoBukti
              ? `<img class="foto-thumb" data-photo-store="penjualanPhotos" data-photo-id="${t.id}"
                       style="height:45px;cursor:pointer;border-radius:5px;">`
              : '-'}
          </td>
          <td>${t.keterangan || ''}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary btn-edit-tpen me-1" data-id="${t.id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger btn-del-tpen" data-id="${t.id}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

    tbody.querySelectorAll('.btn-del-tpen').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        if (!confirm('Hapus penjualan ke pengepul ini?')) return;
        const t = data.penjualanPengepul.find(x => x.id === id);
        if (t && t.fotoBukti) {
          deletePhoto('penjualanPhotos', id);
        }
        data.penjualanPengepul = data.penjualanPengepul.filter(t => t.id !== id);
        saveData();
      });
    });

    tbody.querySelectorAll('.btn-edit-tpen').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        const t = data.penjualanPengepul.find(x => x.id === id);
        if (!t) return;
        document.getElementById('edit-tpen-id').value = t.id;
        document.getElementById('edit-tpen-tanggal').value = t.tanggal;
        document.getElementById('edit-tpen-pengepul-id').value = t.pengepulId;
        document.getElementById('edit-tpen-karung').value = t.jumlahKarung;
        document.getElementById('edit-tpen-totalkg').value = t.totalKg;
        document.getElementById('edit-tpen-harga-kg').value = t.hargaPerKg;
        document.getElementById('edit-tpen-total-harga').value = t.totalHarga;
        document.getElementById('edit-tpen-status').value = t.statusPembayaran || 'Lunas';
        document.getElementById('edit-tpen-metode').value = t.metodePembayaran || 'Tunai';
        document.getElementById('edit-tpen-keterangan').value = t.keterangan || '';
        document.getElementById('edit-tpen-foto').value = '';
        const imgPrev = document.getElementById('preview-edit-tpen-foto');
        imgPrev.src = '';
        if (t.fotoBukti) {
          getPhoto('penjualanPhotos', t.id).then(rec => {
            if (rec && rec.blob) {
              imgPrev.src = URL.createObjectURL(rec.blob);
            }
          });
        }
        new bootstrap.Modal(document.getElementById('modalEditPenjualanPengepul')).show();
      });
    });

    loadAllThumbnails();
    attachPreviewEvents();
  }

  document.getElementById('form-edit-penjualan-pengepul').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = Number(document.getElementById('edit-tpen-id').value);
    const tanggal = document.getElementById('edit-tpen-tanggal').value;
    const pengepulId = Number(document.getElementById('edit-tpen-pengepul-id').value);
    const jumlahKarung = toNumber(document.getElementById('edit-tpen-karung').value);
    const totalKg = toNumber(document.getElementById('edit-tpen-totalkg').value);
    const hargaPerKg = toNumber(document.getElementById('edit-tpen-harga-kg').value);
    const totalHarga = toNumber(document.getElementById('edit-tpen-total-harga').value) || (totalKg * hargaPerKg);
    const statusPembayaran = document.getElementById('edit-tpen-status').value || 'Lunas';
    const metodePembayaran = document.getElementById('edit-tpen-metode').value || 'Tunai';
    const keterangan = document.getElementById('edit-tpen-keterangan').value.trim();
    const fileFoto = document.getElementById('edit-tpen-foto').files[0];

    const idx = data.penjualanPengepul.findIndex(t => t.id === id);
    if (idx < 0) return;

    data.penjualanPengepul[idx].tanggal = tanggal;
    data.penjualanPengepul[idx].pengepulId = pengepulId;
    data.penjualanPengepul[idx].jumlahKarung = jumlahKarung;
    data.penjualanPengepul[idx].totalKg = totalKg;
    data.penjualanPengepul[idx].hargaPerKg = hargaPerKg;
    data.penjualanPengepul[idx].totalHarga = totalHarga;
    data.penjualanPengepul[idx].statusPembayaran = statusPembayaran;
    data.penjualanPengepul[idx].metodePembayaran = metodePembayaran;
    data.penjualanPengepul[idx].keterangan = keterangan;

    function doneSave(hasFoto) {
      if (hasFoto !== null) data.penjualanPengepul[idx].fotoBukti = hasFoto;
      saveData();
      bootstrap.Modal.getInstance(document.getElementById('modalEditPenjualanPengepul')).hide();
    }

    if (fileFoto) {
      savePhoto('penjualanPhotos', id, fileFoto).then(() => doneSave(true));
    } else {
      doneSave(null);
    }
  });

  // Biaya
  document.getElementById('form-biaya').addEventListener('submit', (e) => {
    e.preventDefault();
    const tanggal = document.getElementById('biaya-tanggal').value;
    const kategori = document.getElementById('biaya-kategori').value;
    const deskripsi = document.getElementById('biaya-deskripsi').value.trim();
    const nominal = toNumber(document.getElementById('biaya-nominal').value);
    if (!tanggal || !nominal) return;
    const fileFoto = document.getElementById('biaya-foto').files[0];
    const newId = Date.now();

    function pushAndSave(hasFoto) {
      data.biaya.push({
        id: newId,
        tanggal,
        kategori,
        deskripsi,
        nominal,
        fotoBukti: !!hasFoto
      });
      document.getElementById('biaya-foto').value = '';
      document.getElementById('biaya-tanggal').value = '';
      document.getElementById('biaya-deskripsi').value = '';
      document.getElementById('biaya-nominal').value = '';
      saveData();
    }

    if (fileFoto) {
      savePhoto('biayaPhotos', newId, fileFoto).then(() => pushAndSave(true));
    } else {
      pushAndSave(false);
    }
  });

  function renderBiaya() {
    const tbody = document.getElementById('table-biaya-body');
    tbody.innerHTML = '';
    data.biaya
      .slice()
      .sort((a,b) => a.tanggal.localeCompare(b.tanggal))
      .forEach((b, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${formatDateID(b.tanggal)}</td>
          <td>${b.kategori}</td>
          <td>${b.deskripsi || ''}</td>
          <td class="text-end">${formatRupiah(b.nominal)}</td>
          <td class="text-center">
            ${b.fotoBukti
              ? `<img class="foto-thumb" data-photo-store="biayaPhotos" data-photo-id="${b.id}"
                       style="height:45px;cursor:pointer;border-radius:5px;">`
              : '-'}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-secondary btn-edit-biaya me-1" data-id="${b.id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger btn-del-biaya" data-id="${b.id}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

    tbody.querySelectorAll('.btn-del-biaya').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        if (!confirm('Hapus biaya ini?')) return;
        const b = data.biaya.find(x => x.id === id);
        if (b && b.fotoBukti) {
          deletePhoto('biayaPhotos', id);
        }
        data.biaya = data.biaya.filter(b => b.id !== id);
        saveData();
      });
    });

    tbody.querySelectorAll('.btn-edit-biaya').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        const b = data.biaya.find(x => x.id === id);
        if (!b) return;
        document.getElementById('edit-biaya-id').value = b.id;
        document.getElementById('edit-biaya-tanggal').value = b.tanggal;
        document.getElementById('edit-biaya-kategori').value = b.kategori;
        document.getElementById('edit-biaya-deskripsi').value = b.deskripsi || '';
        document.getElementById('edit-biaya-nominal').value = b.nominal;
        document.getElementById('edit-biaya-foto').value = '';
        const imgPrev = document.getElementById('preview-edit-biaya-foto');
        imgPrev.src = '';
        if (b.fotoBukti) {
          getPhoto('biayaPhotos', b.id).then(rec => {
            if (rec && rec.blob) {
              imgPrev.src = URL.createObjectURL(rec.blob);
            }
          });
        }
        new bootstrap.Modal(document.getElementById('modalEditBiaya')).show();
      });
    });

    loadAllThumbnails();
    attachPreviewEvents();
  }

  document.getElementById('form-edit-biaya').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = Number(document.getElementById('edit-biaya-id').value);
    const tanggal = document.getElementById('edit-biaya-tanggal').value;
    const kategori = document.getElementById('edit-biaya-kategori').value;
    const deskripsi = document.getElementById('edit-biaya-deskripsi').value.trim();
    const nominal = toNumber(document.getElementById('edit-biaya-nominal').value);
    const fileFoto = document.getElementById('edit-biaya-foto').files[0];

    const idx = data.biaya.findIndex(b => b.id === id);
    if (idx >= 0) {
      data.biaya[idx].tanggal = tanggal;
      data.biaya[idx].kategori = kategori;
      data.biaya[idx].deskripsi = deskripsi;
      data.biaya[idx].nominal = nominal;

      function doneSave(hasFoto) {
        if (hasFoto !== null) data.biaya[idx].fotoBukti = hasFoto;
        saveData();
        bootstrap.Modal.getInstance(document.getElementById('modalEditBiaya')).hide();
      }

      if (fileFoto) {
        savePhoto('biayaPhotos', id, fileFoto).then(() => doneSave(true));
      } else {
        doneSave(null);
      }
    }
  });

  // Dashboard
  function updateDashboard() {
    const start = document.getElementById('dash-start').value;
    const end = document.getElementById('dash-end').value;

    function inRange(dateStr) {
      if (!dateStr) return false;
      if (start && dateStr < start) return false;
      if (end && dateStr > end) return false;
      return true;
    }

    const filteredPenjualan = data.penjualanPengepul.filter(t => inRange(t.tanggal));
    const filteredBiaya = data.biaya.filter(b => inRange(b.tanggal));
    const filteredTP = data.transaksiPetani.filter(tp => inRange(tp.tanggal));

    const totalPenjualan = filteredPenjualan.reduce((sum, t) => sum + (t.totalHarga || 0), 0);
    const totalBiaya = filteredBiaya.reduce((sum, b) => sum + (b.nominal || 0), 0);
    const labaRugi = totalPenjualan - totalBiaya;

    const totalPompaKarung = filteredTP.reduce((sum, t) => sum + (t.hasilPompaKarung || 0), 0);
    const totalPetaniKarung = filteredTP.reduce((sum, t) => sum + (t.hasilPetaniKarung || 0), 0);

    document.getElementById('dash-total-pemasukan').textContent = formatRupiah(totalPenjualan);
    document.getElementById('dash-total-biaya').textContent = formatRupiah(totalBiaya);
    document.getElementById('dash-laba-rugi').textContent = formatRupiah(labaRugi);
    document.getElementById('dash-bagi-pompa').textContent = totalPompaKarung + ' Karung';
    document.getElementById('dash-bagi-petani').textContent = totalPetaniKarung + ' Karung';
  }
  document.getElementById('btn-filter-dashboard').addEventListener('click', updateDashboard);
  document.getElementById('btn-reset-dashboard').addEventListener('click', () => {
    document.getElementById('dash-start').value = '';
    document.getElementById('dash-end').value = '';
    updateDashboard();
  });
  // function updateDashboard() {
  //   const totalPenjualan = data.penjualanPengepul.reduce((sum, t) => sum + (t.totalHarga || 0), 0);
  //   const totalBiaya = data.biaya.reduce((sum, b) => sum + (b.nominal || 0), 0);
  //   const labaRugi = totalPenjualan - totalBiaya;
  //   const totalPompaKarung = data.transaksiPetani.reduce((sum, t) => sum + (t.hasilPompaKarung || 0), 0);
  //   const totalPetaniKarung = data.transaksiPetani.reduce((sum, t) => sum + (t.hasilPetaniKarung || 0), 0);

  //   document.getElementById('dash-total-pemasukan').textContent = formatRupiah(totalPenjualan);
  //   document.getElementById('dash-total-biaya').textContent = formatRupiah(totalBiaya);
  //   document.getElementById('dash-laba-rugi').textContent = formatRupiah(labaRugi);
  //   document.getElementById('dash-bagi-pompa').textContent = totalPompaKarung + ' Karung';
  //   document.getElementById('dash-bagi-petani').textContent = totalPetaniKarung + ' Karung';
  // }

  // Laporan
  // function hitungLaporan() {
  //   const bulanVal = document.getElementById('laporan-bulan').value;
  //   let filterYear = null, filterMonth = null;
  //   if (bulanVal) {
  //     const parts = bulanVal.split('-');
  //     if (parts.length === 2) {
  //       filterYear = parts[0];
  //       filterMonth = parts[1];
  //     }
  //   }
  //   function matchPeriode(isoDate) {
  //     if (!filterYear || !filterMonth) return true;
  //     const [y, m] = isoDate.split('-');
  //     return y === filterYear && m === filterMonth;
  //   }

  //   const totalPenjualan = data.penjualanPengepul
  //     .filter(t => matchPeriode(t.tanggal))
  //     .reduce((sum, t) => sum + (t.totalHarga || 0), 0);

  //   const totalBiaya = data.biaya
  //     .filter(b => matchPeriode(b.tanggal))
  //     .reduce((sum, b) => sum + (b.nominal || 0), 0);

  //   const labaRugi = totalPenjualan - totalBiaya;

  //   document.getElementById('lap-total-pemasukan').textContent = formatRupiah(totalPenjualan);
  //   document.getElementById('lap-total-biaya').textContent = formatRupiah(totalBiaya);
  //   document.getElementById('lap-laba-rugi').textContent = formatRupiah(labaRugi);
  // }
  function hitungLaporan() {
    const start = document.getElementById('laporan-start').value;
    const end = document.getElementById('laporan-end').value;

    function inRange(dateStr) {
      if (!dateStr) return false;
      if (start && dateStr < start) return false;
      if (end && dateStr > end) return false;
      return true;
    }

    const totalPenjualan = data.penjualanPengepul
      .filter(t => inRange(t.tanggal))
      .reduce((sum, t) => sum + (t.totalHarga || 0), 0);

    const totalBiaya = data.biaya
      .filter(b => inRange(b.tanggal))
      .reduce((sum, b) => sum + (b.nominal || 0), 0);

    const labaRugi = totalPenjualan - totalBiaya;

    document.getElementById('lap-total-pemasukan').textContent = formatRupiah(totalPenjualan);
    document.getElementById('lap-total-biaya').textContent = formatRupiah(totalBiaya);
    document.getElementById('lap-laba-rugi').textContent = formatRupiah(labaRugi);
  }

  document.getElementById('btn-hitung-laporan').addEventListener('click', hitungLaporan);

  // Backup JSON
  document.getElementById('btn-export-json').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'data-pembukuan-pompa.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  document.getElementById('input-import-json').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!confirm('Import JSON akan menimpa semua data. Lanjutkan?')) {
      e.target.value = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        const imported = JSON.parse(evt.target.result);
        if (!imported || typeof imported !== 'object') throw new Error('Format tidak sesuai');
        data = Object.assign(getDefaultData(), imported);
        saveData();
        alert('Import JSON berhasil.\nCatatan: Foto tidak ikut, karena tersimpan lokal di IndexedDB.');
      } catch (err) {
        console.error(err);
        alert('File JSON tidak valid.');
      } finally {
        e.target.value = '';
      }
    };
    reader.readAsText(file);
  });

  // Export Excel (tanpa foto)
  document.getElementById('btn-export-excel').addEventListener('click', () => {
    try {
      const wb = XLSX.utils.book_new();

      const petaniSheet = XLSX.utils.json_to_sheet(
        data.petani.map(p => ({
          id: p.id,
          nama: p.nama,
          catatan: p.catatan || ''
        }))
      );
      XLSX.utils.book_append_sheet(wb, petaniSheet, 'petani');

      const pengepulSheet = XLSX.utils.json_to_sheet(
        data.pengepul.map(p => ({
          id: p.id,
          nama: p.nama,
          catatan: p.catatan || ''
        }))
      );
      XLSX.utils.book_append_sheet(wb, pengepulSheet, 'pengepul');

      const tpSheet = XLSX.utils.json_to_sheet(
        data.transaksiPetani.map(t => ({
          id: t.id,
          tanggal: t.tanggal,
          petaniId: t.petaniId,
          jumlahKarungPanen: t.jumlahKarungPanen,
          jumlahPupuk: t.jumlahPupuk,
          hasilPompaKarung: t.hasilPompaKarung,
          hasilPetaniKarung: t.hasilPetaniKarung,
          keterangan: t.keterangan || ''
        }))
      );
      XLSX.utils.book_append_sheet(wb, tpSheet, 'transaksi_petani');

      const tpenSheet = XLSX.utils.json_to_sheet(
        data.penjualanPengepul.map(t => ({
          id: t.id,
          tanggal: t.tanggal,
          pengepulId: t.pengepulId,
          jumlahKarung: t.jumlahKarung,
          totalKg: t.totalKg,
          hargaPerKg: t.hargaPerKg,
          totalHarga: t.totalHarga,
          statusPembayaran: t.statusPembayaran,
          metodePembayaran: t.metodePembayaran,
          keterangan: t.keterangan || ''
        }))
      );
      XLSX.utils.book_append_sheet(wb, tpenSheet, 'penjualan_pengepul');

      const biayaSheet = XLSX.utils.json_to_sheet(
        data.biaya.map(b => ({
          id: b.id,
          tanggal: b.tanggal,
          kategori: b.kategori,
          deskripsi: b.deskripsi || '',
          nominal: b.nominal
        }))
      );
      XLSX.utils.book_append_sheet(wb, biayaSheet, 'biaya');

      XLSX.writeFile(wb, 'data-pembukuan-pompa.xlsx');
    } catch (err) {
      console.error(err);
      alert('Gagal export Excel.');
    }
  });

  // Import Excel
  document.getElementById('input-import-excel').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!confirm('Import Excel akan menimpa semua data. Pastikan file berasal dari export aplikasi ini. Lanjutkan?')) {
      e.target.value = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        const imported = getDefaultData();

        function readSheet(name, handler) {
          const sheet = wb.Sheets[name];
          if (!sheet) return;
          const rows = XLSX.utils.sheet_to_json(sheet);
          handler(rows);
        }

        readSheet('petani', rows => {
          imported.petani = rows.map((r, idx) => ({
            id: Number(r.id) || Date.now() + idx,
            nama: r.nama || '',
            catatan: r.catatan || ''
          }));
        });

        readSheet('pengepul', rows => {
          imported.pengepul = rows.map((r, idx) => ({
            id: Number(r.id) || Date.now() + idx,
            nama: r.nama || '',
            catatan: r.catatan || ''
          }));
        });

        readSheet('transaksi_petani', rows => {
          imported.transaksiPetani = rows.map((r, idx) => ({
            id: Number(r.id) || Date.now() + idx,
            tanggal: r.tanggal || '',
            petaniId: Number(r.petaniId) || 0,
            jumlahKarungPanen: toNumber(r.jumlahKarungPanen),
            jumlahPupuk: toNumber(r.jumlahPupuk),
            hasilPompaKarung: toNumber(r.hasilPompaKarung),
            hasilPetaniKarung: toNumber(r.hasilPetaniKarung),
            keterangan: r.keterangan || ''
          }));
        });

        readSheet('penjualan_pengepul', rows => {
          imported.penjualanPengepul = rows.map((r, idx) => {
            const totalKg = toNumber(r.totalKg);
            const hargaPerKg = toNumber(r.hargaPerKg);
            const totalHarga = toNumber(r.totalHarga) || (totalKg * hargaPerKg);
            return {
              id: Number(r.id) || Date.now() + idx,
              tanggal: r.tanggal || '',
              pengepulId: Number(r.pengepulId) || 0,
              jumlahKarung: toNumber(r.jumlahKarung),
              totalKg,
              hargaPerKg,
              totalHarga,
              statusPembayaran: r.statusPembayaran || 'Lunas',
              metodePembayaran: r.metodePembayaran || 'Tunai',
              keterangan: r.keterangan || '',
              fotoBukti: false
            };
          });
        });

        readSheet('biaya', rows => {
          imported.biaya = rows.map((r, idx) => ({
            id: Number(r.id) || Date.now() + idx,
            tanggal: r.tanggal || '',
            kategori: r.kategori || 'Lain-lain',
            deskripsi: r.deskripsi || '',
            nominal: toNumber(r.nominal),
            fotoBukti: false
          }));
        });

        data = imported;
        saveData();
        alert('Import Excel berhasil.\nCatatan: Foto tidak ikut import.');
      } catch (err) {
        console.error(err);
        alert('File Excel tidak valid atau format sheet tidak sesuai.');
      } finally {
        e.target.value = '';
      }
    };
    reader.readAsBinaryString(file);
  });

  // Clear all data + IndexedDB
  document.getElementById('btn-clear-data').addEventListener('click', () => {
    if (confirm("Semua data akan dihapus permanen (termasuk foto di IndexedDB). Lanjutkan?")) {
      localStorage.removeItem(STORAGE_KEY);
      data = getDefaultData();
      // hapus database foto
      if ('indexedDB' in window) {
        indexedDB.deleteDatabase(PHOTO_DB_NAME);
        photoDBPromise = null;
      }
      saveData();
      alert("Semua data berhasil dihapus.");
    }
  });

  // Render All
  function updateAllUI() {
    renderPetani();
    renderPengepul();
    renderTransaksiPetani();
    renderPenjualanPengepul();
    renderBiaya();
    updateDashboard();
  }

  updateAllUI();
</script>
</body>
</html>