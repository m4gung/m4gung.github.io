<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Aplikasi Penjualan - Hybrid + Rupiah</title>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Chart.js (optional) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: Arial; margin: 16px; }
  input, select, button { padding: 6px; margin: 4px; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th, td { border: 1px solid #777; padding: 6px; font-size: 14px; }
  th { background: #eee; }
  .card { border: 1px solid #ccc; padding: 12px; margin-bottom: 16px; }
  .hidden { display: none; }
</style>
</head>
<body>

<h2>Aplikasi Penjualan - Final Hybrid + Format Rupiah</h2>

<!-- =========================================================== -->
<!-- MASTER PRODUK -->
<!-- =========================================================== -->
<div class="card">
  <h3>Master Produk</h3>

  <input id="id_produk" placeholder="ID Produk">
  <input id="nama_produk" placeholder="Nama Produk">
  <input id="modal_total" type="number" placeholder="Modal Total">
  <input id="stok_produk" type="number" placeholder="Stok">
  <input id="harga_jual_satuan" type="number" placeholder="Harga Jual / pcs">
  <br>
  <button id="btnSimpanProduk">Simpan</button>
  <button id="btnClearProduk">Clear</button>
  <br>
  <label>Import Produk:</label>
  <input id="importProduk" type="file" accept=".xlsx,.xls">
  <button id="btnExportProduk">Export Produk</button>

  <h4>Daftar Produk</h4>
  <table>
    <thead>
      <tr>
        <th>ID</th><th>Nama</th><th>Modal Total</th><th>Modal/pcs</th><th>Stok</th><th>Harga Jual</th><th>Aksi</th>
      </tr>
    </thead>
    <tbody id="tabelProduk"></tbody>
  </table>
</div>

<!-- =========================================================== -->
<!-- TRANSAKSI -->
<!-- =========================================================== -->
<div class="card">
  <h3>Transaksi Penjualan</h3>

  <input id="nama_pembeli" placeholder="Nama Pembeli">

  <select id="pilih_produk"></select>

  <input id="harga_trans_modal" type="number" placeholder="Modal/pcs" disabled>
  <input id="harga_trans_jual" type="number" placeholder="Harga Jual / pcs">
  <input id="qty_jual" type="number" placeholder="Qty">

  <br>
  <button id="btnProses">Proses</button>
  <br>

  <label>Import Transaksi:</label>
  <input id="importTransaksi" type="file" accept=".xlsx,.xls">
  <button id="btnExportTransaksi">Export Transaksi</button>

  <h4>Daftar Transaksi</h4>
  <table>
    <thead>
      <tr>
        <th>Pembeli</th>
        <th>Produk</th>
        <th>Modal/pcs</th>
        <th>Jual/pcs</th>
        <th>Qty</th>
        <th>Total Modal</th>
        <th>Total Jual</th>
        <th>Laba</th>
        <th>Tanggal</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="tabelTransaksi"></tbody>
  </table>
</div>

<!-- =========================================================== -->
<!-- REPORT -->
<!-- =========================================================== -->
<div class="card">
  <h3>Report Penjualan</h3>

  <label>Filter Produk:</label>
  <select id="filter_produk"></select>

  <label>Dari:</label>
  <input id="filter_mulai" type="date">

  <label>Sampai:</label>
  <input id="filter_akhir" type="date">

  <button id="btnFilter">Filter</button>
  <button id="btnResetFilter">Reset</button>

  <br><br>

  <p><b>Total Modal:</b> <span id="totalModal">Rp 0,00</span></p>
  <p><b>Total Omzet:</b> <span id="totalOmzet">Rp 0,00</span></p>
  <p><b>Total Laba:</b> <span id="totalLaba">Rp 0,00</span></p>

  <button id="btnExportLaporan">Export Laporan</button>

  <div id="chartWrapper" style="margin-top:12px;">
    <canvas id="chartLaporan" height="120"></canvas>
    <div id="chartFallback" class="hidden">Grafik tidak tersedia pada browser ini.</div>
  </div>
</div>

<script>
/* ============================
   Format Rupiah Indonesia
============================ */
function formatRupiah(angka){
  if(angka === null || angka === undefined) return "Rp 0,00";
  angka = parseFloat(angka);
  if(isNaN(angka)) return "Rp 0,00";

  var parts = angka.toFixed(2).split(".");
  var ribuan = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  return "Rp " + ribuan + "," + parts[1];
}

/* ============================
   Local Storage Helper
============================ */
function load(k){ 
  try { return JSON.parse(localStorage.getItem(k) || "[]"); }
  catch(e){ return []; }
}
function save(k,v){
  try { localStorage.setItem(k,JSON.stringify(v)); } catch(e){}
}

function escapeHtml(s){
  if(s===null || s===undefined) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/* ============================
   MASTER PRODUK
============================ */
function renderProduk(){
  var produk = load("produk");
  var tbody = document.getElementById("tabelProduk");
  var out = "";

  for(var i=0;i<produk.length;i++){
    var p = produk[i];
    var modalPer = p.modal_per_pcs || (p.modal_total / p.stok);

    out += "<tr>";
    out += "<td>"+p.id+"</td>";
    out += "<td>"+escapeHtml(p.nama)+"</td>";
    out += "<td>"+formatRupiah(p.modal_total)+"</td>";
    out += "<td>"+formatRupiah(modalPer)+"</td>";
    out += "<td>"+p.stok+"</td>";
    out += "<td>"+formatRupiah(p.harga_jual)+"</td>";
    out += "<td><button class='editProduk' data-idx='"+i+"'>Edit</button> <button class='delProduk' data-idx='"+i+"'>Hapus</button></td>";
    out += "</tr>";
  }

  tbody.innerHTML = out;
  renderDropdowns();
}

function simpanProduk(){
  var id = document.getElementById("id_produk").value.trim();
  var nama = document.getElementById("nama_produk").value.trim();
  var modal = parseFloat(document.getElementById("modal_total").value);
  var stok = parseInt(document.getElementById("stok_produk").value);
  var harga = parseFloat(document.getElementById("harga_jual_satuan").value);

  if(!id || !nama || modal<=0 || stok<=0 || harga<=0){
    alert("Lengkapi data produk!");
    return;
  }

  var modalPer = modal/stok;

  var produk = load("produk");
  var idx=-1;
  for(var i=0;i<produk.length;i++){
    if(produk[i].id===id){ idx=i; break; }
  }

  var data = {
    id:id, nama:nama,
    modal_total:modal,
    modal_per_pcs:modalPer,
    stok:stok,
    harga_jual:harga
  };

  if(idx>=0) produk[idx]=data; else produk.push(data);

  save("produk",produk);
  clearProdukForm();
  renderProduk();
}

function clearProdukForm(){
  id_produk.value="";
  nama_produk.value="";
  modal_total.value="";
  stok_produk.value="";
  harga_jual_satuan.value="";
}

function produkTableClick(e){
  var t = e.target;
  if(t.tagName!=="BUTTON") return;
  var idx = parseInt(t.getAttribute("data-idx"));
  var produk = load("produk");

  if(t.className==="editProduk"){
    var p = produk[idx];
    id_produk.value=p.id;
    nama_produk.value=p.nama;
    modal_total.value=p.modal_total;
    stok_produk.value=p.stok;
    harga_jual_satuan.value=p.harga_jual;
  }
  else if(t.className==="delProduk"){
    if(confirm("Hapus produk?")){
      produk.splice(idx,1);
      save("produk",produk);
      renderProduk();
    }
  }
}

function importProdukExcel(){
  var fi = document.getElementById("importProduk");
  if(!fi.files[0]) return;
  var reader=new FileReader();
  reader.onload=function(e){
    var wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
    var sheet=wb.Sheets[wb.SheetNames[0]];
    var rows=XLSX.utils.sheet_to_json(sheet);

    var out=[];
    for(var i=0;i<rows.length;i++){
      var r=rows[i];
      var id=r.id;
      var nama=r.nama;
      var modal=r.modal_total;
      var stok=r.stok;
      var harga=r.harga_jual;
      if(id && nama && modal>0 && stok>0){
        out.push({
          id:id,
          nama:nama,
          modal_total:modal,
          modal_per_pcs:modal/stok,
          stok:stok,
          harga_jual:harga
        });
      }
    }

    save("produk",out);
    renderProduk();
  };
  reader.readAsArrayBuffer(fi.files[0]);
}

function exportProduk(){
  var data=load("produk");
  if(!data.length){ alert("Tidak ada produk!"); return; }

  var out=[];
  for(var i=0;i<data.length;i++){
    out.push({
      id:data[i].id,
      nama:data[i].nama,
      modal_total:data[i].modal_total,
      stok:data[i].stok,
      harga_jual:data[i].harga_jual
    });
  }

  var ws=XLSX.utils.json_to_sheet(out);
  var wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Produk");
  XLSX.writeFile(wb,"Master_Produk.xlsx");
}

/* ============================
   Dropdowns
============================ */
function renderDropdowns(){
  var produk=load("produk");
  var sel=document.getElementById("pilih_produk");
  var opt="<option value=''>Pilih Produk...</option>";
  for(var i=0;i<produk.length;i++){
    opt += "<option value='"+produk[i].id+"'>"+escapeHtml(produk[i].nama)+"</option>";
  }
  sel.innerHTML=opt;

  var fp=document.getElementById("filter_produk");
  var opt2="<option value=''>Semua Produk</option>";
  for(var j=0;j<produk.length;j++){
    opt2 += "<option value='"+produk[j].id+"'>"+escapeHtml(produk[j].nama)+"</option>";
  }
  fp.innerHTML=opt2;
}

/* ============================
   TRANSAKSI
============================ */
function isiInfoProduk(){
  var pid=document.getElementById("pilih_produk").value;
  if(!pid){ harga_trans_modal.value=""; harga_trans_jual.value=""; return; }

  var produk=load("produk");
  for(var i=0;i<produk.length;i++){
    if(produk[i].id===pid){
      harga_trans_modal.value = produk[i].modal_per_pcs;
      harga_trans_jual.value = produk[i].harga_jual;
    }
  }
}

function simpanTransaksi(){
  var nama=document.getElementById("nama_pembeli").value.trim();
  var pid=document.getElementById("pilih_produk").value;
  var qty=parseInt(document.getElementById("qty_jual").value);
  var harga=parseFloat(document.getElementById("harga_trans_jual").value);

  if(!nama){ alert("Nama pembeli wajib!"); return; }
  if(!pid || qty<=0 || harga<=0){ alert("Lengkapi transaksi!"); return; }

  var produk=load("produk");
  var p=null;
  for(var i=0;i<produk.length;i++){
    if(produk[i].id===pid){ p=produk[i]; break; }
  }
  if(!p){ alert("Produk tidak ditemukan!"); return; }
  if(p.stok<qty){ alert("Stok tidak cukup!"); return; }

  var modal=p.modal_per_pcs;
  var totalModal = modal*qty;
  var totalJual = harga*qty;
  var laba = totalJual-totalModal;

  var trx=load("transaksi");
  trx.push({
    pembeli:nama,
    id_produk:pid,
    nama:p.nama,
    harga_modal_per_pcs:modal,
    harga_jual_per_pcs:harga,
    qty:qty,
    total_modal:totalModal,
    total_jual:totalJual,
    laba:laba,
    tanggal:new Date().toString()
  });

  // kurangi stok
  p.stok -= qty;
  save("produk",produk);
  save("transaksi",trx);

  renderProduk();
  renderTransaksi();
  renderReport();
  updateChartSafe();
  
  document.getElementById("nama_pembeli").value="";
  document.getElementById("qty_jual").value="";
}

function renderTransaksi(){
  var trx=load("transaksi");
  var tbody=document.getElementById("tabelTransaksi");
  var out="";

  for(var i=0;i<trx.length;i++){
    var t=trx[i];
    out+="<tr>";
    out+="<td>"+escapeHtml(t.pembeli)+"</td>";
    out+="<td>"+escapeHtml(t.nama)+"</td>";
    out+="<td>"+formatRupiah(t.harga_modal_per_pcs)+"</td>";
    out+="<td>"+formatRupiah(t.harga_jual_per_pcs)+"</td>";
    out+="<td>"+t.qty+"</td>";
    out+="<td>"+formatRupiah(t.total_modal)+"</td>";
    out+="<td>"+formatRupiah(t.total_jual)+"</td>";
    out+="<td>"+formatRupiah(t.laba)+"</td>";
    out+="<td>"+escapeHtml(t.tanggal)+"</td>";
    out+="<td><button class='delTrans' data-idx='"+i+"'>Hapus</button></td>";
    out+="</tr>";
  }

  tbody.innerHTML=out;
}

function transaksiTableClick(e){
  var t=e.target;
  if(t.tagName!=="BUTTON") return;
  var idx=parseInt(t.getAttribute("data-idx"));
  var trx=load("transaksi");

  if(t.className==="delTrans"){
    if(confirm("Hapus transaksi ini?")){
      trx.splice(idx,1);
      save("transaksi",trx);
      renderTransaksi();
      renderReport();
      updateChartSafe();
    }
  }
}

function importTransaksiExcel(){
  var fi=document.getElementById("importTransaksi");
  if(!fi.files[0]) return;

  var reader=new FileReader();
  reader.onload=function(e){
    var wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
    var sheet=wb.Sheets[wb.SheetNames[0]];
    var rows=XLSX.utils.sheet_to_json(sheet);
    save("transaksi",rows);
    renderTransaksi();
    renderReport();
    updateChartSafe();
  };
  reader.readAsArrayBuffer(fi.files[0]);
}

function exportTransaksi(){
  var trx=load("transaksi");
  if(!trx.length){ alert("Tidak ada transaksi!"); return; }

  var ws=XLSX.utils.json_to_sheet(trx);
  var wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Transaksi");
  XLSX.writeFile(wb,"Data_Transaksi.xlsx");
}

/* ============================
   REPORT & FILTER
============================ */
function applyFilter(){
  var mulai=document.getElementById("filter_mulai").value;
  var akhir=document.getElementById("filter_akhir").value;
  var fp=document.getElementById("filter_produk").value;

  var trx=load("transaksi");
  var out=[];

  var tMulai = mulai ? new Date(mulai+" 00:00:00").getTime() : -Infinity;
  var tAkhir = akhir ? new Date(akhir+" 23:59:59").getTime() : Infinity;

  for(var i=0;i<trx.length;i++){
    var t=trx[i];
    var time=new Date(t.tanggal).getTime();
    if(time>=tMulai && time<=tAkhir){
      if(fp){
        if(t.id_produk===fp) out.push(t);
      } else out.push(t);
    }
  }

  // tampilkan hasil filter
  var tbody=document.getElementById("tabelTransaksi");
  var html="";
  for(var j=0;j<out.length;j++){
    var t=out[j];
    html+="<tr>";
    html+="<td>"+escapeHtml(t.pembeli)+"</td>";
    html+="<td>"+escapeHtml(t.nama)+"</td>";
    html+="<td>"+formatRupiah(t.harga_modal_per_pcs)+"</td>";
    html+="<td>"+formatRupiah(t.harga_jual_per_pcs)+"</td>";
    html+="<td>"+t.qty+"</td>";
    html+="<td>"+formatRupiah(t.total_modal)+"</td>";
    html+="<td>"+formatRupiah(t.total_jual)+"</td>";
    html+="<td>"+formatRupiah(t.laba)+"</td>";
    html+="<td>"+escapeHtml(t.tanggal)+"</td>";
    html+="<td></td>";
    html+="</tr>";
  }
  tbody.innerHTML=html;

  // hitung ulang total
  var tm=0, to=0, tl=0;
  for(var k=0;k<out.length;k++){
    tm += out[k].total_modal || 0;
    to += out[k].total_jual || 0;
    tl += out[k].laba || 0;
  }

  document.getElementById("totalModal").innerText=formatRupiah(tm);
  document.getElementById("totalOmzet").innerText=formatRupiah(to);
  document.getElementById("totalLaba").innerText=formatRupiah(tl);

  updateChartSafe(out);
}

function resetFilter(){
  filter_mulai.value="";
  filter_akhir.value="";
  filter_produk.value="";

  renderTransaksi();
  renderReport();
  updateChartSafe();
}

function renderReport(){
  var trx=load("transaksi");
  var tm=0,to=0,tl=0;

  for(var i=0;i<trx.length;i++){
    tm += trx[i].total_modal||0;
    to += trx[i].total_jual||0;
    tl += trx[i].laba||0;
  }

  totalModal.innerText=formatRupiah(tm);
  totalOmzet.innerText=formatRupiah(to);
  totalLaba.innerText=formatRupiah(tl);
}

function exportLaporan(){
  alert("Gunakan Export Transaksi (hasil filter) untuk laporan format Excel.");
}

/* ============================
   CHART SAFE MODE
============================ */
var chartInstance=null;

function updateChartSafe(data){
  try {
    var canvasSupported = !!document.createElement('canvas').getContext;
    if(!canvasSupported || typeof Chart==="undefined"){
      chartLaporan.style.display="none";
      chartFallback.className="";
      chartFallback.innerHTML="Grafik tidak tersedia di browser ini.";
      return;
    }

    var arr = data || load("transaksi");
    var tm=0,to=0,tl=0;

    for(var i=0;i<arr.length;i++){
      tm+=arr[i].total_modal||0;
      to+=arr[i].total_jual||0;
      tl+=arr[i].laba||0;
    }

    chartFallback.style.display="none";
    chartLaporan.style.display="";

    var ctx=chartLaporan.getContext("2d");

    if(chartInstance){
      try{ chartInstance.destroy(); }catch(e){}
    }

    chartInstance=new Chart(ctx,{
      type:"bar",
      data:{
        labels:["Total Modal","Total Omzet","Total Laba"],
        datasets:[{
          label:"Jumlah",
          data:[tm,to,tl]
        }]
      }
    });

  } catch(e){
    chartLaporan.style.display="none";
    chartFallback.innerHTML="Grafik tidak tersedia.";
  }
}

/* ============================
   INIT
============================ */
window.onload=function(){
  btnSimpanProduk.onclick=simpanProduk;
  btnClearProduk.onclick=clearProdukForm;
  tabelProduk.onclick=produkTableClick;
  pilih_produk.onchange=isiInfoProduk;
  btnProses.onclick=simpanTransaksi;
  tabelTransaksi.onclick=transaksiTableClick;

  importProduk.onchange=importProdukExcel;
  btnExportProduk.onclick=exportProduk;

  importTransaksi.onchange=importTransaksiExcel;
  btnExportTransaksi.onclick=exportTransaksi;

  btnFilter.onclick=applyFilter;
  btnResetFilter.onclick=resetFilter;

  btnExportLaporan.onclick=exportLaporan;

  renderProduk();
  renderTransaksi();
  renderReport();
  updateChartSafe();
};
</script>

</body>
</html>