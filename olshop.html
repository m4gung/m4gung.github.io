<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Aplikasi Penjualan Final</title>

<!-- Excel Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { font-family: Arial; margin: 20px; }
    input, select { padding: 6px; margin: 5px; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #444; padding: 6px; }
    th { background: #eee; }
    .card { border: 1px solid #ccc; padding: 15px; margin-bottom: 25px; }
</style>
</head>
<body>

<h1>Aplikasi Penjualan (Final Version + Nama Pembeli)</h1>

<!-- =========================================================== -->
<!-- MASTER PRODUK -->
<!-- =========================================================== -->
<div class="card">
    <h2>Master Produk</h2>

    <input id="id_produk" placeholder="ID Produk">
    <input id="nama_produk" placeholder="Nama Produk">
    <input id="modal_total" type="number" placeholder="Modal Total">
    <input id="stok_produk" type="number" placeholder="Stok">
    <input id="harga_jual_satuan" type="number" placeholder="Harga Jual / pcs">

    <button onclick="simpanProduk()">Simpan</button>
    <button onclick="clearProdukForm()">Clear</button>

    <br>
    <label>Import Produk:</label>
    <input type="file" id="importProduk" accept=".xlsx,.xls" onchange="importProdukExcel()">
    <button onclick="exportProduk()">Export Produk</button>

    <h3>Daftar Produk</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th><th>Nama</th><th>Modal Total</th><th>Modal/pcs</th><th>Stok</th><th>Harga Jual</th><th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabelProduk"></tbody>
    </table>
</div>

<!-- =========================================================== -->
<!-- TRANSAKSI -->
<!-- =========================================================== -->
<div class="card">
    <h2>Transaksi Penjualan</h2>

    <input id="nama_pembeli" placeholder="Nama Pembeli">

    <select id="pilih_produk" onchange="isiInfoProduk()"></select>

    <input id="harga_trans_modal" type="number" placeholder="Modal/pcs" disabled>
    <input id="harga_trans_jual" type="number" placeholder="Harga Jual / pcs">
    <input id="qty_jual" type="number" placeholder="Qty">

    <button onclick="simpanTransaksi()">Proses</button>

    <br>
    <label>Import Transaksi:</label>
    <input type="file" id="importTransaksi" accept=".xlsx,.xls" onchange="importTransaksiExcel()">
    <button onclick="exportTransaksi()">Export Transaksi</button>

    <h3>Daftar Transaksi</h3>
    <table>
        <thead>
            <tr>
                <th>Pembeli</th>
                <th>Produk</th>
                <th>Modal/pcs</th>
                <th>Jual/pcs</th>
                <th>Qty</th>
                <th>Total Modal</th>
                <th>Total Jual</th>
                <th>Laba</th>
                <th>Tanggal</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabelTransaksi"></tbody>
    </table>
</div>

<!-- =========================================================== -->
<!-- REPORT -->
<!-- =========================================================== -->
<div class="card">
    <h2>Report Penjualan</h2>

    <label>Filter Produk:</label>
    <select id="filter_produk" onchange="filterReport()"></select>

    <br>

    <label>Dari Tanggal:</label>
    <input type="date" id="filter_mulai" onchange="filterReport()">

    <label>Sampai:</label>
    <input type="date" id="filter_akhir" onchange="filterReport()">

    <br><br>

    <p>Total Modal: <span id="totalModal">0</span></p>
    <p>Total Omzet: <span id="totalOmzet">0</span></p>
    <p>Total Laba: <span id="totalLaba">0</span></p>

    <button onclick="exportLaporan()">Export Laporan</button>

    <br><br>
    <canvas id="chartLaporan" height="100"></canvas>
</div>

<script>
/* STORAGE */
function load(k){ return JSON.parse(localStorage.getItem(k)||"[]"); }
function save(k,v){ localStorage.setItem(k,JSON.stringify(v)); }

/* ============================================================
   MASTER PRODUK
============================================================ */
function simpanProduk(){
    let id = id_produk.value.trim();
    let nama = nama_produk.value.trim();
    let modal_total = parseFloat(modal_total.value);
    let stok = parseInt(stok_produk.value);
    let harga_jual = parseFloat(harga_jual_satuan.value);

    if(!id || !nama || !modal_total || !stok || !harga_jual){
        alert("Lengkapi semua data produk!"); return;
    }

    let modal_per_pcs = modal_total / stok;

    let produk = load("produk");
    let idx = produk.findIndex(p=>p.id===id);

    let data = { id,nama,modal_total,modal_per_pcs,stok,harga_jual };

    if(idx>=0) produk[idx]=data;
    else produk.push(data);

    save("produk",produk);
    clearProdukForm();
    renderProduk();
}

function clearProdukForm(){
    id_produk.value="";
    nama_produk.value="";
    modal_total.value="";
    stok_produk.value="";
    harga_jual_satuan.value="";
}

function renderProduk(){
    let produk=load("produk");
    let html="";

    produk.forEach((p,i)=>{
        html+=`
        <tr>
            <td>${p.id}</td>
            <td>${p.nama}</td>
            <td>${p.modal_total}</td>
            <td>${p.modal_per_pcs.toFixed(2)}</td>
            <td>${p.stok}</td>
            <td>${p.harga_jual}</td>
            <td>
                <button onclick="editProduk(${i})">Edit</button>
                <button onclick="hapusProduk(${i})">Delete</button>
            </td>
        </tr>`;
    });

    tabelProduk.innerHTML = html;
    renderDropdownProduk();
}

function editProduk(i){
    let p = load("produk")[i];
    id_produk.value=p.id;
    nama_produk.value=p.nama;
    modal_total.value=p.modal_total;
    stok_produk.value=p.stok;
    harga_jual_satuan.value=p.harga_jual;
}

function hapusProduk(i){
    let produk=load("produk");
    produk.splice(i,1);
    save("produk",produk);
    renderProduk();
}

/* EXPORT PRODUK */
function exportProduk(){
    let data=load("produk");
    if(data.length===0) return alert("Tidak ada produk!");

    let cleaned=data.map(p=>({
        id:p.id,
        nama:p.nama,
        modal_total:p.modal_total,
        stok:p.stok,
        harga_jual:p.harga_jual
    }));

    let ws=XLSX.utils.json_to_sheet(cleaned);
    let wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Produk");
    XLSX.writeFile(wb,"Master_Produk.xlsx");
}

/* IMPORT PRODUK */
function importProdukExcel(){
    let file=importProduk.files[0];
    let reader=new FileReader();

    reader.onload=e=>{
        let wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
        let rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

        rows=rows.map(p=>({
            id:p.id,
            nama:p.nama,
            modal_total:p.modal_total,
            stok:p.stok,
            harga_jual:p.harga_jual,
            modal_per_pcs:p.modal_total / p.stok
        }));

        save("produk",rows);
        renderProduk();
    };

    reader.readAsArrayBuffer(file);
}

/* DROPDOWN PRODUK */
function renderDropdownProduk(){
    let produk=load("produk");

    // transaksi
    let html=`<option value="">Pilih Produk...</option>`;
    produk.forEach(p=> html+=`<option value="${p.id}">${p.nama}</option>`);
    pilih_produk.innerHTML=html;

    // filter report
    let f=`<option value="">Semua Produk</option>`;
    produk.forEach(p=> f+=`<option value="${p.id}">${p.nama}</option>`);
    filter_produk.innerHTML=f;
}

/* ============================================================
   TRANSAKSI
============================================================ */
function isiInfoProduk(){
    let p = load("produk").find(x=>x.id==pilih_produk.value);
    if(!p) return;
    harga_trans_modal.value = p.modal_per_pcs;
    harga_trans_jual.value = p.harga_jual;
}

function simpanTransaksi(){
    let namaPembeli = nama_pembeli.value.trim();
    let idProduk = pilih_produk.value;
    let qty = parseInt(qty_jual.value);
    let hargaJual = parseFloat(harga_trans_jual.value);

    if(!namaPembeli){ alert("Nama pembeli wajib diisi!"); return; }
    if(!idProduk || !qty || !hargaJual){ alert("Lengkapi transaksi!"); return; }

    let produk = load("produk");
    let p = produk.find(x=>x.id==idProduk);

    if(!p) return alert("Produk tidak ditemukan!");
    if(p.stok < qty) return alert("Stok tidak cukup!");

    let modal = p.modal_per_pcs;
    let totalModal = modal * qty;
    let totalJual = hargaJual * qty;
    let laba = totalJual - totalModal;

    let trx = load("transaksi");
    trx.push({
        pembeli: namaPembeli,
        id_produk: idProduk,
        nama: p.nama,
        harga_modal_per_pcs: modal,
        harga_jual_per_pcs: hargaJual,
        qty,
        total_modal: totalModal,
        total_jual: totalJual,
        laba,
        tanggal: new Date().toLocaleString()
    });

    p.stok -= qty;

    save("produk", produk);
    save("transaksi", trx);

    renderProduk();
    renderTransaksi();
    renderReport();
    updateChart(trx);
}

function renderTransaksi(){
    let trx = load("transaksi");
    let html="";

    trx.forEach((t,i)=>{
        html += `
        <tr>
            <td>${t.pembeli}</td>
            <td>${t.nama}</td>
            <td>${t.harga_modal_per_pcs.toFixed(2)}</td>
            <td>${t.harga_jual_per_pcs}</td>
            <td>${t.qty}</td>
            <td>${t.total_modal.toFixed(2)}</td>
            <td>${t.total_jual}</td>
            <td>${t.laba}</td>
            <td>${t.tanggal}</td>
            <td>
                <button onclick="hapusTransaksi(${i})">Hapus</button>
            </td>
        </tr>`;
    });

    tabelTransaksi.innerHTML = html;
}

function hapusTransaksi(i){
    let trx = load("transaksi");
    trx.splice(i,1);
    save("transaksi",trx);
    renderTransaksi();
    renderReport();
}

/* IMPORT TRANSAKSI */
function importTransaksiExcel(){
    let file=importTransaksi.files[0];
    let reader=new FileReader();

    reader.onload=e=>{
        let wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
        let rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        save("transaksi",rows);
        renderTransaksi();
        renderReport();
        updateChart(rows);
    };

    reader.readAsArrayBuffer(file);
}

/* EXPORT TRANSAKSI */
function exportTransaksi(){
    let trx=load("transaksi");
    if(trx.length===0) return alert("Tidak ada transaksi!");

    let ws=XLSX.utils.json_to_sheet(trx);
    let wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Transaksi");
    XLSX.writeFile(wb,"Data_Transaksi.xlsx");
}

/* ============================================================
   REPORT FILTER
============================================================ */
function filterReport(){
    let mulai=filter_mulai.value;
    let akhir=filter_akhir.value;
    let fp=filter_produk.value;

    let trx=load("transaksi");

    let tMulai = mulai ? new Date(mulai+" 00:00:00").getTime() : 0;
    let tAkhir = akhir ? new Date(akhir+" 23:59:59").getTime() : Infinity;

    let filtered = trx.filter(t=>{
        let tgl=new Date(t.tanggal).getTime();
        let matchTgl = tgl >= tMulai && tgl <= tAkhir;
        let matchProduk = fp ? t.id_produk === fp : true;
        return matchTgl && matchProduk;
    });

    let html="";
    filtered.forEach(t=>{
        html+=`
        <tr>
            <td>${t.pembeli}</td>
            <td>${t.nama}</td>
            <td>${t.harga_modal_per_pcs}</td>
            <td>${t.harga_jual_per_pcs}</td>
            <td>${t.qty}</td>
            <td>${t.total_modal}</td>
            <td>${t.total_jual}</td>
            <td>${t.laba}</td>
            <td>${t.tanggal}</td>
            <td></td>
        </tr>`;
    });
    tabelTransaksi.innerHTML = html;

    totalModal.innerText = filtered.reduce((a,b)=>a+b.total_modal,0);
    totalOmzet.innerText = filtered.reduce((a,b)=>a+b.total_jual,0);
    totalLaba.innerText  = filtered.reduce((a,b)=>a+b.laba,0);

    updateChart(filtered);
}

/* EXPORT LAPORAN */
function exportLaporan(){ exportTransaksi(); }

/* ============================================================
   GRAFIK
============================================================ */
let chart=null;

function updateChart(data){
    let modal= data.reduce((a,b)=>a+b.total_modal,0);
    let omzet= data.reduce((a,b)=>a+b.total_jual,0);
    let laba = data.reduce((a,b)=>a+b.laba,0);

    let ctx=document.getElementById("chartLaporan");

    if(chart) chart.destroy();

    chart=new Chart(ctx,{
        type:"bar",
        data:{
            labels:["Modal","Omzet","Laba"],
            datasets:[{
                label:"Grafik Laporan",
                data:[modal,omzet,laba]
            }]
        }
    });
}

/* INIT */
renderProduk();
renderTransaksi();
renderReport();
updateChart(load("transaksi"));
</script>

</body>
</html>