<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Aplikasi Penjualan Lengkap</title>

    <!-- Library Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: Arial; margin: 20px; }
        input, select { padding: 5px; margin: 5px; }
        button { padding: 6px 12px; margin: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #333; padding: 6px; text-align: left; }
        th { background: #eee; }
        .card { border: 1px solid #ccc; padding: 15px; margin-bottom: 25px; }
    </style>
</head>
<body>

<h1>Aplikasi Penjualan (CRUD + Transaksi + Report)</h1>

<!-- ===================================================== -->
<!-- MASTER PRODUK CRUD -->
<!-- ===================================================== -->
<div class="card">
    <h2>Master Produk</h2>

    <input id="id_produk" placeholder="ID Produk">
    <input id="nama_produk" placeholder="Nama Produk">
    <input id="modal_produk" type="number" placeholder="Harga Modal">
    <input id="harga_produk" type="number" placeholder="Harga Jual">
    <input id="stok_produk" type="number" placeholder="Stok">

    <button onclick="simpanProduk()">Simpan</button>
    <button onclick="clearProdukForm()">Clear</button>
    <input type="file" id="importProduk" accept=".xlsx,.xls" onchange="importProdukExcel()">

    <h3>Daftar Produk</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th><th>Nama</th><th>Modal</th><th>Harga</th><th>Stok</th><th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabelProduk"></tbody>
    </table>
</div>

<!-- ===================================================== -->
<!-- TRANSAKSI -->
<!-- ===================================================== -->
<div class="card">
    <h2>Transaksi Penjualan</h2>

    <select id="pilih_produk" onchange="isiInfoProduk()"></select>

    <input id="harga_jual" type="number" placeholder="Harga">
    <input id="qty_jual" type="number" placeholder="Qty">

    <button onclick="simpanTransaksi()">Proses</button>
    <input type="file" id="importTransaksi" accept=".xlsx,.xls" onchange="importTransaksiExcel()">

    <h3>Daftar Transaksi</h3>
    <table>
        <thead>
            <tr>
                <th>Produk</th><th>Harga</th><th>Qty</th><th>Total</th><th>Laba</th><th>Tanggal</th><th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabelTransaksi"></tbody>
    </table>
</div>

<!-- ===================================================== -->
<!-- REPORT -->
<!-- ===================================================== -->
<div class="card">
    <h2>Report Penjualan</h2>

    <p><b>Total Omzet:</b> <span id="totalOmzet">0</span></p>
    <p><b>Total Laba:</b> <span id="totalLaba">0</span></p>

    <button onclick="exportExcel()">Export Report to Excel</button>
</div>

<script>
/* ============================================================
    DATABASE LOCALSTORAGE
============================================================ */
function load(key) {
    let data = localStorage.getItem(key);
    return data ? JSON.parse(data) : [];
}
function save(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
}

/* ============================================================
    CRUD MASTER PRODUK
============================================================ */
function renderProduk() {
    let db = load("produk");
    let html = "";
    db.forEach((p, i) => {
        html += `
        <tr>
            <td>${p.id}</td>
            <td>${p.nama}</td>
            <td>${p.modal}</td>
            <td>${p.harga}</td>
            <td>${p.stok}</td>
            <td>
                <button onclick="editProduk(${i})">Edit</button>
                <button onclick="hapusProduk(${i})">Delete</button>
            </td>
        </tr>`;
    });
    tabelProduk.innerHTML = html;
    renderDropdownProduk();
}

function simpanProduk() {
    let id = id_produk.value;
    let nama = nama_produk.value;
    let modal = parseInt(modal_produk.value);
    let harga = parseInt(harga_produk.value);
    let stok = parseInt(stok_produk.value);
    if (!id || !nama) return alert("Lengkapi data!");

    let db = load("produk");
    let idx = db.findIndex(p => p.id === id);

    if (idx >= 0)
        db[idx] = { id, nama, modal, harga, stok }; // Update
    else
        db.push({ id, nama, modal, harga, stok }); // Insert

    save("produk", db);
    clearProdukForm();
    renderProduk();
}

function clearProdukForm() {
    id_produk.value = "";
    nama_produk.value = "";
    modal_produk.value = "";
    harga_produk.value = "";
    stok_produk.value = "";
}

function editProduk(i) {
    let p = load("produk")[i];
    id_produk.value = p.id;
    nama_produk.value = p.nama;
    modal_produk.value = p.modal;
    harga_produk.value = p.harga;
    stok_produk.value = p.stok;
}

function hapusProduk(i) {
    let db = load("produk");
    db.splice(i, 1);
    save("produk", db);
    renderProduk();
}

/* ============================================================
    IMPORT EXCEL MASTER PRODUK
============================================================ */
function importProdukExcel() {
    let file = importProduk.files[0];
    let reader = new FileReader();

    reader.onload = function(e) {
        let data = new Uint8Array(e.target.result);
        let workbook = XLSX.read(data, { type: "array" });
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let rows = XLSX.utils.sheet_to_json(sheet);

        save("produk", rows);
        renderProduk();
    };

    reader.readAsArrayBuffer(file);
}

/* ============================================================
    DROPDOWN PRODUK UNTUK TRANSAKSI
============================================================ */
function renderDropdownProduk() {
    let db = load("produk");
    let html = `<option value="">Pilih Produk...</option>`;
    db.forEach(p => {
        html += `<option value="${p.id}">${p.nama}</option>`;
    });
    pilih_produk.innerHTML = html;
}

function isiInfoProduk() {
    let id = pilih_produk.value;
    let db = load("produk");
    let p = db.find(x => x.id == id);
    if (p) harga_jual.value = p.harga;
}

/* ============================================================
    TRANSAKSI (ADD, EDIT, DELETE)
============================================================ */
function renderTransaksi() {
    let db = load("transaksi");
    let html = "";
    db.forEach((t, i) => {
        html += `
        <tr>
            <td>${t.nama}</td>
            <td>${t.harga}</td>
            <td>${t.qty}</td>
            <td>${t.total}</td>
            <td>${t.laba}</td>
            <td>${t.tanggal}</td>
            <td>
                <button onclick="editTransaksi(${i})">Edit</button>
                <button onclick="hapusTransaksi(${i})">Delete</button>
            </td>
        </tr>`;
    });
    tabelTransaksi.innerHTML = html;
    renderReport();
}

function simpanTransaksi() {
    let id = pilih_produk.value;
    let qty = parseInt(qty_jual.value);
    let harga = parseInt(harga_jual.value);

    if (!id || !qty) return alert("Isi data transaksi!");

    let produk = load("produk");
    let p = produk.find(x => x.id == id);

    if (p.stok < qty) return alert("Stok kurang!");

    let total = harga * qty;
    let laba = (harga - p.modal) * qty;

    let trx = load("transaksi");

    trx.push({
        id_produk: id,
        nama: p.nama,
        harga,
        qty,
        total,
        laba,
        tanggal: new Date().toLocaleString()
    });

    p.stok -= qty;
    save("produk", produk);
    save("transaksi", trx);

    renderProduk();
    renderTransaksi();
}

/* ============================================================
    EDIT TRANSAKSI
============================================================ */
let transaksiIndex = -1;

function editTransaksi(i) {
    let t = load("transaksi")[i];
    transaksiIndex = i;

    pilih_produk.value = t.id_produk;
    harga_jual.value = t.harga;
    qty_jual.value = t.qty;

    // Ganti tombol proses
    document.querySelector("button[onclick='simpanTransaksi()']").innerText = "Update Transaksi";
    document.querySelector("button[onclick='simpanTransaksi()']").onclick = updateTransaksi;
}

function updateTransaksi() {
    let trx = load("transaksi");
    let t = trx[transaksiIndex];

    let id = pilih_produk.value;
    let qty = parseInt(qty_jual.value);
    let harga = parseInt(harga_jual.value);

    let produk = load("produk");
    let p = produk.find(x => x.id == id);

    let total = harga * qty;
    let laba = (harga - p.modal) * qty;

    trx[transaksiIndex] = {
        id_produk: id,
        nama: p.nama,
        harga,
        qty,
        total,
        laba,
        tanggal: new Date().toLocaleString()
    };

    save("transaksi", trx);
    renderTransaksi();

    // Reset tombol
    document.querySelector("button[onclick='updateTransaksi()']").innerText = "Proses";
    document.querySelector("button[onclick='updateTransaksi()']").onclick = simpanTransaksi;
}

/* ============================================================
    HAPUS TRANSAKSI
============================================================ */
function hapusTransaksi(i) {
    let trx = load("transaksi");
    trx.splice(i, 1);
    save("transaksi", trx);
    renderTransaksi();
}

/* ============================================================
    IMPORT EXCEL TRANSAKSI
============================================================ */
function importTransaksiExcel() {
    let file = importTransaksi.files[0];
    let reader = new FileReader();

    reader.onload = function(e) {
        let data = new Uint8Array(e.target.result);
        let workbook = XLSX.read(data, { type: "array" });
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let rows = XLSX.utils.sheet_to_json(sheet);

        save("transaksi", rows);
        renderTransaksi();
    };

    reader.readAsArrayBuffer(file);
}

/* ============================================================
    REPORT
============================================================ */
function renderReport() {
    let trx = load("transaksi");
    totalOmzet.innerHTML = trx.reduce((a, b) => a + b.total, 0);
    totalLaba.innerHTML = trx.reduce((a, b) => a + b.laba, 0);
}

/* ============================================================
    EXPORT EXCEL
============================================================ */
function exportExcel() {
    let trx = load("transaksi");
    let ws = XLSX.utils.json_to_sheet(trx);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Report");
    XLSX.writeFile(wb, "laporan_penjualan.xlsx");
}

/* ============================================================
    ONLOAD INIT
============================================================ */
renderProduk();
renderTransaksi();
renderReport();

</script>

</body>
</html>