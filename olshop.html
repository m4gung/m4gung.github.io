<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Aplikasi Penjualan</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    body { font-family: Arial; margin: 20px; }
    input, select { padding: 6px; margin: 5px; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 6px; }
    th { background: #eee; }
    .card { border: 1px solid #ccc; padding: 15px; margin-bottom: 25px; }
</style>
</head>
<body>

<h1>Aplikasi Penjualan (FINAL)</h1>

<!-- ============================================================= -->
<!-- MASTER PRODUK -->
<!-- ============================================================= -->
<div class="card">
    <h2>Master Produk</h2>

    <input id="id_produk" placeholder="ID Produk">
    <input id="nama_produk" placeholder="Nama Produk">
    <input id="modal_total" type="number" placeholder="Modal Total (semua stok)">
    <input id="stok_produk" type="number" placeholder="Stok Produk">
    <input id="harga_jual_satuan" type="number" placeholder="Harga Jual / pcs">

    <button onclick="simpanProduk()">Simpan</button>
    <button onclick="clearProdukForm()">Clear</button>
    <br>
    <input type="file" id="importProduk" accept=".xlsx,.xls" onchange="importProdukExcel()">
    <button onclick="exportProduk()">Export Produk</button>

    <h3>Daftar Produk</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th><th>Nama</th><th>Modal Total</th><th>Modal/pcs</th><th>Stok</th><th>Harga Jual</th><th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabelProduk"></tbody>
    </table>
</div>

<!-- ============================================================= -->
<!-- TRANSAKSI -->
<!-- ============================================================= -->
<div class="card">
    <h2>Transaksi Penjualan</h2>

    <select id="pilih_produk" onchange="isiInfoProduk()"></select>

    <input id="harga_trans_modal" type="number" placeholder="Modal/pcs" disabled>
    <input id="harga_trans_jual" type="number" placeholder="Harga Jual/pcs">
    <input id="qty_jual" type="number" placeholder="Qty">

    <button onclick="simpanTransaksi()">Proses</button>
    <br>
    <input type="file" id="importTransaksi" accept=".xlsx,.xls" onchange="importTransaksiExcel()">
    <button onclick="exportTransaksi()">Export Transaksi</button>

    <h3>Daftar Transaksi</h3>
    <table>
        <thead>
            <tr>
                <th>Produk</th><th>Modal/pcs</th><th>Jual/pcs</th><th>Qty</th>
                <th>Total Modal</th><th>Total Jual</th><th>Laba</th><th>Tanggal</th><th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabelTransaksi"></tbody>
    </table>
</div>

<!-- ============================================================= -->
<!-- REPORT -->
<!-- ============================================================= -->
<div class="card">
    <h2>Report</h2>
    <p>Total Modal: <span id="totalModal">0</span></p>
    <p>Total Omzet: <span id="totalOmzet">0</span></p>
    <p>Total Laba: <span id="totalLaba">0</span></p>
    <button onclick="exportLaporan()">Export Laporan</button>
</div>

<script>
/* ==========================================
   STORAGE
========================================== */
function load(k){ return JSON.parse(localStorage.getItem(k)||"[]"); }
function save(k,v){ localStorage.setItem(k,JSON.stringify(v)); }

/* ==========================================
   MASTER PRODUK
========================================== */
function simpanProduk(){
    let id = document.getElementById("id_produk").value.trim();
    let nama = document.getElementById("nama_produk").value.trim();
    let modal_total = parseFloat(document.getElementById("modal_total").value);
    let stok = parseInt(document.getElementById("stok_produk").value);
    let harga_jual = parseFloat(document.getElementById("harga_jual_satuan").value);

    if(!id || !nama || !modal_total || !stok || !harga_jual){
        alert("Lengkapi semua data produk!");
        return;
    }

    let modal_per_pcs = modal_total / stok;

    let produk = load("produk");
    let idx = produk.findIndex(x=>x.id===id);

    let data = {
        id, nama, modal_total, modal_per_pcs, stok, harga_jual
    };

    if(idx >= 0) produk[idx] = data;
    else produk.push(data);

    save("produk", produk);
    clearProdukForm();
    renderProduk();
}

function clearProdukForm(){
    document.getElementById("id_produk").value="";
    document.getElementById("nama_produk").value="";
    document.getElementById("modal_total").value="";
    document.getElementById("stok_produk").value="";
    document.getElementById("harga_jual_satuan").value="";
}

function renderProduk(){
    let produk = load("produk");
    let html = "";
    produk.forEach((p,i)=>{
        html += `
        <tr>
            <td>${p.id}</td>
            <td>${p.nama}</td>
            <td>${p.modal_total}</td>
            <td>${p.modal_per_pcs.toFixed(2)}</td>
            <td>${p.stok}</td>
            <td>${p.harga_jual}</td>
            <td>
                <button onclick="editProduk(${i})">Edit</button>
                <button onclick="hapusProduk(${i})">Delete</button>
            </td>
        </tr>`;
    });
    document.getElementById("tabelProduk").innerHTML = html;
    renderDropdownProduk();
}

function editProduk(i){
    let p = load("produk")[i];
    document.getElementById("id_produk").value = p.id;
    document.getElementById("nama_produk").value = p.nama;
    document.getElementById("modal_total").value = p.modal_total;
    document.getElementById("stok_produk").value = p.stok;
    document.getElementById("harga_jual_satuan").value = p.harga_jual;
}

function hapusProduk(i){
    let produk = load("produk");
    produk.splice(i,1);
    save("produk",produk);
    renderProduk();
}

/* ==========================================
   EXPORT PRODUK
========================================== */
function exportProduk(){
    let data = load("produk");
    if(data.length===0) return alert("Tidak ada data");

    let exportData = data.map(p => ({
        id: p.id,
        nama: p.nama,
        modal_total: p.modal_total,
        stok: p.stok,
        harga_jual: p.harga_jual
    }));

    let ws = XLSX.utils.json_to_sheet(exportData);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Produk");
    XLSX.writeFile(wb,"Master_Produk.xlsx");
}

/* ==========================================
   IMPORT PRODUK
========================================== */
function importProdukExcel(){
    let file = document.getElementById("importProduk").files[0];
    let reader = new FileReader();

    reader.onload = e=>{
        let wb = XLSX.read(new Uint8Array(e.target.result),{type:"array"});
        let rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

        // tambah modal/pcs otomatis
        rows = rows.map(p => ({
            id: p.id,
            nama: p.nama,
            modal_total: p.modal_total,
            stok: p.stok,
            harga_jual: p.harga_jual,
            modal_per_pcs: p.modal_total / p.stok
        }));

        save("produk", rows);
        renderProduk();
    };

    reader.readAsArrayBuffer(file);
}

/* ==========================================
   TRANSAKSI
========================================== */
function renderDropdownProduk(){
    let produk = load("produk");
    let html = `<option value="">Pilih Produk...</option>`;
    produk.forEach(p=>{
        html += `<option value="${p.id}">${p.nama}</option>`;
    });
    document.getElementById("pilih_produk").innerHTML = html;
}

function isiInfoProduk(){
    let produk = load("produk");
    let p = produk.find(x=>x.id==document.getElementById("pilih_produk").value);
    if(!p) return;
    document.getElementById("harga_trans_modal").value = p.modal_per_pcs;
    document.getElementById("harga_trans_jual").value = p.harga_jual;
}

function simpanTransaksi(){
    let id = document.getElementById("pilih_produk").value;
    let qty = parseInt(document.getElementById("qty_jual").value);
    let harga_jual = parseFloat(document.getElementById("harga_trans_jual").value);

    if(!id || !qty || !harga_jual){
        alert("Lengkapi transaksi!");
        return;
    }

    let produk = load("produk");
    let p = produk.find(x=>x.id==id);

    if(p.stok < qty){
        alert("Stok tidak cukup!");
        return;
    }

    let modal_per_pcs = p.modal_per_pcs;

    let total_modal = modal_per_pcs * qty;
    let total_jual = harga_jual * qty;
    let laba = total_jual - total_modal;

    let trx = load("transaksi");
    trx.push({
        id_produk:id,
        nama:p.nama,
        harga_modal_per_pcs:modal_per_pcs,
        harga_jual_per_pcs:harga_jual,
        qty,
        total_modal,
        total_jual,
        laba,
        tanggal:new Date().toLocaleString()
    });

    p.stok -= qty;

    save("produk",produk);
    save("transaksi",trx);

    renderProduk();
    renderTransaksi();
    renderReport();
}

function renderTransaksi(){
    let trx = load("transaksi");
    let html = "";

    trx.forEach((t,i)=>{
        html += `
        <tr>
            <td>${t.nama}</td>
            <td>${t.harga_modal_per_pcs.toFixed(2)}</td>
            <td>${t.harga_jual_per_pcs}</td>
            <td>${t.qty}</td>
            <td>${t.total_modal.toFixed(2)}</td>
            <td>${t.total_jual}</td>
            <td>${t.laba}</td>
            <td>${t.tanggal}</td>
            <td><button onclick="hapusTransaksi(${i})">Hapus</button></td>
        </tr>`;
    });

    document.getElementById("tabelTransaksi").innerHTML = html;
}

/* ==========================================
   DELETE TRANSAKSI
========================================== */
function hapusTransaksi(i){
    let trx = load("transaksi");
    trx.splice(i,1);
    save("transaksi",trx);
    renderTransaksi();
    renderReport();
}

/* ==========================================
   IMPORT TRANSAKSI
========================================== */
function importTransaksiExcel(){
    let file = document.getElementById("importTransaksi").files[0];
    let reader = new FileReader();

    reader.onload = e=>{
        let wb = XLSX.read(new Uint8Array(e.target.result),{type:"array"});
        let rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        save("transaksi",rows);
        renderTransaksi();
        renderReport();
    };

    reader.readAsArrayBuffer(file);
}

/* ==========================================
   EXPORT TRANSAKSI
========================================== */
function exportTransaksi(){
    let trx = load("transaksi");
    if(trx.length===0) return alert("Tidak ada transaksi!");

    let ws = XLSX.utils.json_to_sheet(trx);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Transaksi");
    XLSX.writeFile(wb,"Data_Transaksi.xlsx");
}

/* ==========================================
   REPORT
========================================== */
function renderReport(){
    let trx = load("transaksi");
    document.getElementById("totalModal").innerText = trx.reduce((a,b)=>a+b.total_modal,0);
    document.getElementById("totalOmzet").innerText = trx.reduce((a,b)=>a+b.total_jual,0);
    document.getElementById("totalLaba").innerText = trx.reduce((a,b)=>a+b.laba,0);
}

/* ==========================================
   EXPORT LAPORAN = EXPORT TRANSAKSI
========================================== */
function exportLaporan(){ exportTransaksi(); }

/* ==========================================
   INIT
========================================== */
renderProduk();
renderTransaksi();
renderReport();
</script>

</body>
</html>