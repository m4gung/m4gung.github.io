<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Aplikasi Penjualan Lengkap</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: Arial; margin: 20px; }
        input, select { padding: 5px; margin: 5px; }
        button { padding: 6px 12px; margin: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #333; padding: 6px; text-align: left; }
        th { background: #eee; }
        .card { border: 1px solid #ccc; padding: 15px; margin-bottom: 25px; }
    </style>
</head>
<body>

<h1>Aplikasi Penjualan Lengkap</h1>

<!-- ===================================================== -->
<!-- MASTER PRODUK -->
<!-- ===================================================== -->
<div class="card">
    <h2>Master Produk</h2>

    <input id="id_produk" placeholder="ID Produk">
    <input id="nama_produk" placeholder="Nama Produk">

    <!-- Modal total untuk seluruh stok -->
    <input id="modal_total" type="number" placeholder="Total Modal (Keseluruhan)">
    <input id="stok_produk" type="number" placeholder="Jumlah Stok">

    <!-- Harga jual per pcs -->
    <input id="harga_jual_satuan" type="number" placeholder="Harga Jual / pcs">

    <button onclick="simpanProduk()">Simpan</button>
    <button onclick="clearProdukForm()">Clear</button>
    <input type="file" id="importProduk" accept=".xlsx,.xls" onchange="importProdukExcel()">

    <h3>Daftar Produk</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nama Produk</th>
                <th>Modal Total</th>
                <th>Modal / pcs</th>
                <th>Stok</th>
                <th>Harga Jual / pcs</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabelProduk"></tbody>
    </table>
</div>

<!-- ===================================================== -->
<!-- TRANSAKSI -->
<!-- ===================================================== -->
<div class="card">
    <h2>Transaksi Penjualan</h2>

    <select id="pilih_produk" onchange="isiInfoProduk()"></select>

    <input id="harga_trans_modal" type="number" placeholder="Harga Modal / pcs" disabled>
    <input id="harga_trans_jual" type="number" placeholder="Harga Jual / pcs">

    <input id="qty_jual" type="number" placeholder="Qty">

    <button onclick="simpanTransaksi()">Proses</button>
    <input type="file" id="importTransaksi" accept=".xlsx,.xls" onchange="importTransaksiExcel()">

    <h3>Daftar Transaksi</h3>
    <table>
        <thead>
            <tr>
                <th>Produk</th>
                <th>Modal/pcs</th>
                <th>Jual/pcs</th>
                <th>Qty</th>
                <th>Total Modal</th>
                <th>Total Jual</th>
                <th>Laba</th>
                <th>Tanggal</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tabelTransaksi"></tbody>
    </table>
</div>

<!-- ===================================================== -->
<!-- REPORT -->
<!-- ===================================================== -->
<div class="card">
    <h2>Report Penjualan</h2>

    <p><b>Total Modal:</b> <span id="totalModal">0</span></p>
    <p><b>Total Omzet:</b> <span id="totalOmzet">0</span></p>
    <p><b>Total Laba:</b> <span id="totalLaba">0</span></p>

    <button onclick="exportExcel()">Export Laporan</button>
</div>

<script>
/* ============================================================
   HELPER STORAGE
============================================================ */
function load(k){ return JSON.parse(localStorage.getItem(k) || "[]"); }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ============================================================
   MASTER PRODUK CRUD
============================================================ */
function renderProduk(){
    let db = load("produk");
    let html = "";

    db.forEach((p, i) => {
        html += `
        <tr>
            <td>${p.id}</td>
            <td>${p.nama}</td>
            <td>${p.modal_total}</td>
            <td>${p.modal_per_pcs}</td>
            <td>${p.stok}</td>
            <td>${p.harga_jual}</td>
            <td>
                <button onclick="editProduk(${i})">Edit</button>
                <button onclick="hapusProduk(${i})">Delete</button>
            </td>
        </tr>`;
    });

    tabelProduk.innerHTML = html;
    renderDropdownProduk();
}

function simpanProduk(){
    let id = id_produk.value;
    let nama = nama_produk.value;
    let modal_total = parseInt(modal_total.value);
    let stok = parseInt(stok_produk.value);
    let harga_jual = parseInt(harga_jual_satuan.value);

    if(!id || !nama || !modal_total || !stok || !harga_jual)
        return alert("Lengkapi data produk!");

    let modal_per_pcs = modal_total / stok;

    let db = load("produk");
    let idx = db.findIndex(p => p.id === id);

    let data = {
        id,
        nama,
        modal_total,
        modal_per_pcs,
        stok,
        harga_jual
    };

    if(idx >= 0) db[idx] = data;
    else db.push(data);

    save("produk", db);
    clearProdukForm();
    renderProduk();
}

function clearProdukForm(){
    id_produk.value = "";
    nama_produk.value = "";
    modal_total.value = "";
    stok_produk.value = "";
    harga_jual_satuan.value = "";
}

function editProduk(i){
    let p = load("produk")[i];
    id_produk.value = p.id;
    nama_produk.value = p.nama;
    modal_total.value = p.modal_total;
    stok_produk.value = p.stok;
    harga_jual_satuan.value = p.harga_jual;
}

function hapusProduk(i){
    let db = load("produk");
    db.splice(i,1);
    save("produk", db);
    renderProduk();
}

/* ============================================================
   IMPORT EXCEL PRODUK
============================================================ */
function importProdukExcel(){
    let file = importProduk.files[0];
    let reader = new FileReader();

    reader.onload = function(e){
        let wb = XLSX.read(new Uint8Array(e.target.result),{type:"array"});
        let rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        save("produk", rows);
        renderProduk();
    };

    reader.readAsArrayBuffer(file);
}

/* ============================================================
   DROPDOWN PRODUK + ISI HARGA
============================================================ */
function renderDropdownProduk(){
    let db = load("produk");
    let html = `<option value="">Pilih Produk...</option>`;

    db.forEach(p=>{
        html += `<option value="${p.id}">${p.nama}</option>`;
    });

    pilih_produk.innerHTML = html;
}

function isiInfoProduk(){
    let id = pilih_produk.value;
    let db = load("produk");
    let p = db.find(x => x.id == id);
    if(!p) return;

    harga_trans_modal.value = p.modal_per_pcs;
    harga_trans_jual.value = p.harga_jual;
}

/* ============================================================
   TRANSAKSI CRUD
============================================================ */
let editIndex = -1;

function simpanTransaksi(){
    let id = pilih_produk.value;
    let qty = parseInt(qty_jual.value);

    let produk = load("produk");
    let p = produk.find(x => x.id == id);

    if(!p) return alert("Produk tidak ditemukan!");
    if(p.stok < qty) return alert("Stok tidak cukup!");

    let harga_jual = parseInt(harga_trans_jual.value);
    let modal_per_pcs = p.modal_per_pcs;

    let total_modal = modal_per_pcs * qty;
    let total_jual = harga_jual * qty;
    let laba = total_jual - total_modal;

    let trx = load("transaksi");

    trx.push({
        id_produk: id,
        nama: p.nama,
        harga_modal_per_pcs: modal_per_pcs,
        harga_jual_per_pcs: harga_jual,
        qty,
        total_modal,
        total_jual,
        laba,
        tanggal: new Date().toLocaleString()
    });

    p.stok -= qty;
    save("produk", produk);
    save("transaksi", trx);

    renderProduk();
    renderTransaksi();
    renderReport();
}

function renderTransaksi(){
    let trx = load("transaksi");
    let html = "";

    trx.forEach((t,i)=>{
        html+=`
        <tr>
            <td>${t.nama}</td>
            <td>${t.harga_modal_per_pcs}</td>
            <td>${t.harga_jual_per_pcs}</td>
            <td>${t.qty}</td>
            <td>${t.total_modal}</td>
            <td>${t.total_jual}</td>
            <td>${t.laba}</td>
            <td>${t.tanggal}</td>
            <td>
                <button onclick="editTransaksi(${i})">Edit</button>
                <button onclick="hapusTransaksi(${i})">Delete</button>
            </td>
        </tr>`;
    });

    tabelTransaksi.innerHTML = html;
}

/* ============================================================
   REPORT
============================================================ */
function renderReport(){
    let trx = load("transaksi");

    totalModal.textContent = trx.reduce((a,b)=>a+b.total_modal,0);
    totalOmzet.textContent = trx.reduce((a,b)=>a+b.total_jual,0);
    totalLaba.textContent  = trx.reduce((a,b)=>a+b.laba,0);
}

/* ============================================================
   EXPORT REPORT
============================================================ */
function exportExcel(){
    let trx = load("transaksi");
    let ws = XLSX.utils.json_to_sheet(trx);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Laporan");
    XLSX.writeFile(wb, "Laporan_Penjualan.xlsx");
}

/* ============================================================
   INIT
============================================================ */
renderProduk();
renderTransaksi();
renderReport();

</script>

</body>
</html>